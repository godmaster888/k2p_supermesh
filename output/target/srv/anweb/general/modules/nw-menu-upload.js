"use strict";!function(){var nw=angular.module(regdep("nw-menu-upload"),[]);nw.directive("nwMenuUpload",["$rootScope","$timeout","$http","snackbars","translate","devinfo",function($rootScope,$timeout,$http){return{restrict:"AE",replace:!1,scope:{nwUploadUrl:"@",nwUploadPrepare:"&",nwUploadBegin:"&",nwUploadEnd:"&",nwUseFormData:"=",nwUploadTitle:"@",nwUploadDesc:"@",nwUploadClass:"@"},template:'<span class="addlink {{nwUploadClass}}" > <form method="POST" enctype="multipart/form-data" target="nwMenuUploadTarget">    <input type="file" name="file" class="hidden_element">    <label class="button">{{nwUploadTitle | translate}}</label> </form>   <span>{{nwUploadDesc | translate}}</span></span>',link:function($scope,$element){var uniq_iframe=_.uniqueId("nw_upload_iframe"),form=$element.find("form");form.after('<iframe name="'+uniq_iframe+'" id="'+uniq_iframe+'" width="0" height="0" frameborder="0" />');var iframe=$element.find("iframe"),input=form.find("input").eq(0),label=form.find("label"),uniq_label=_.uniqueId("nw_upload_label");input.attr("id",uniq_label),label.attr("for",$scope.nwUploadUrl);var rootSpan=$element.find("span").eq(0);rootSpan.attr("onclick","document.getElementById('"+uniq_label+"').click()"),form.attr("target",uniq_iframe),form.attr("action",$scope.nwUploadUrl),$element.addClass("nw_menu_upload"),input.bind("change",function(){function formDataUpload(){function handler(){var payload=new FormData;return payload.append("file",input[0].files[0]),$timeout(function(){$scope.nwUploadBegin&&$scope.nwUploadBegin()}),$http({url:$scope.nwUploadUrl,method:"POST",data:payload,headers:{"Content-Type":void 0},transformRequest:angular.identity}).then(function(result){$scope.nwUploadEnd({data:result.data})},function(err){$scope.nwUploadEnd({data:err})})}$scope.nwUploadPrepare?$scope.nwUploadPrepare({cb:handler}):handler()}function iframeUpload(){window[uniq_iframe]=!0,$scope.nwUploadPrepare&&$scope.nwUploadPrepare(),form[0].submit(),$rootScope.$emit("request.started",{config:{url:$scope.nwUploadUrl}}),$scope.nwUploadBegin&&$scope.nwUploadBegin()}(function(){return $scope.nwUseFormData&&void 0!==window.FormData})()?formDataUpload():iframeUpload()}),iframe.bind("load",function(e){var data,json;if(window[uniq_iframe]){try{data=angular.element(e.target).contents().find("body").text()}catch(e){$rootScope.$emit("request.failed",{config:{url:$scope.nwUploadUrl}}),$scope.nwUploadEnd()}if($scope.nwUploadEnd&&data){$rootScope.$emit("request.succeed",{config:{url:$scope.nwUploadUrl}});try{json=JSON.parse(data),$scope.nwUploadEnd({data:json})}catch(e){$scope.nwUploadEnd({data:data})}}}})}}}])}();