"use strict";!function(){var nw=angular.module(regdep("nw-file-upload-form"),[]);nw.directive("nwFileUploadForm",["$rootScope","$timeout","$http",function($rootScope,$timeout,$http){return{restrict:"AE",replace:!1,scope:{nwUploadUrl:"@",nwUploadUrlParams:"&",nwUploadBefore:"&",nwUploadBegin:"&",nwUploadEnd:"&",nwUseFormData:"=",nwFieldButtonTitle:"@",nwSubmitTitle:"@",nwButtonBlockClass:"@",nwSubmitButtonClass:"@",nwLabel:"@",nwLabelStatusText:"@",nwLabelStatusValue:"@",nwUploadOnFirstCustomEvent:"&",nwUploadFirstCustomEventName:"=",nwUploadFirstCustomEventDisable:"=",nwFilename:"=?"},template:'<form method="POST" enctype="multipart/form-data"  target="nwFileUploadFormTarget" class="nw_file_upload_form"><label class="nw_file nwfield_content"><div ng-if="nwLabel">{{ (nwLabel | translate) + ":" }}</div><span class="label {{ nwLabelStatusValue }}" ng-if="nwLabelStatusText">{{ nwLabelStatusText}}</span><div class="button">{{nwFieldButtonTitle | translate}}</div><div class="input">{{filename || (\'file_not_selected\' | translate)}}</div><input type="file" name="file"></label><div class="button_block {{nwButtonBlockClass}}"><button type="submit"class="{{nwSubmitButtonClass}}"ng-disabled="!filename" >{{nwSubmitTitle | translate}}</button><button type="button" class="colored" ng-click="nwUploadOnFirstCustomEvent()" ng-disabled="nwUploadFirstCustomEventDisable" ng-if="nwUploadFirstCustomEventName">{{nwUploadFirstCustomEventName | translate}}</button></div></form>',link:function($scope,$element){function getUrlParams(){var getUploadUrlParams;return console.log("$scope.nwUploadUrlParams",$scope.nwUploadUrlParams),_.isFunction($scope.nwUploadUrlParams)?(getUploadUrlParams=$scope.nwUploadUrlParams(),getUploadUrlParams?_.reduce(getUploadUrlParams(),function(memo,value,key){return memo+(memo?"&":"?")+key+"="+encodeURIComponent(value)},""):""):""}{var iframe,uniq_iframe=_.uniqueId("nw_upload_iframe"),form=$element.find("form"),input=form.find("input").eq(0);form.find("input").eq(1),form.find("input").eq(2)}form.after('<iframe name="'+uniq_iframe+'" id="'+uniq_iframe+'" width="0" height="0" frameborder="0" />'),iframe=$element.find("iframe"),form.attr("target",uniq_iframe),form.attr("action",$scope.nwUploadUrl),input.bind("change",function(){$scope.fileSelect(input[0].value)}),form.bind("submit",function(e){function handler(){isSupportFormData()?formDataUpload():iframeUpload()}function isSupportFormData(){return $scope.nwUseFormData&&void 0!==window.FormData}function iframeUpload(){form[0].submit(),window[uniq_iframe]=!0,$scope.nwUploadBegin&&$scope.nwUploadBegin()()}function formDataUpload(){var payload=new FormData;return payload.append("file",input[0].files[0]),$timeout(function(){$scope.nwUploadBegin&&$scope.nwUploadBegin()()}),$http({url:$scope.nwUploadUrl+getUrlParams(),method:"POST",data:payload,headers:{"Content-Type":void 0},transformRequest:angular.identity}).then(function(result){$scope.nwUploadEnd()({data:result.data})},function(err){$scope.nwUploadEnd()({data:err})})}e.preventDefault();var fwUploadBegin=$scope.nwUploadBefore();fwUploadBegin?fwUploadBegin(handler):handler()}),iframe.bind("load",function(e){var data,json;if(window[uniq_iframe]&&(data=angular.element(e.target).contents().find("body").text(),$scope.nwUploadEnd&&data))try{json=JSON.parse(data),$scope.nwUploadEnd()({data:json})}catch(e){$scope.nwUploadEnd()({data:data})}}),$scope.fileSelect=function(path){$scope.filename=path.slice(path.lastIndexOf("\\")+1),$scope.nwFilename=path.slice(path.lastIndexOf("\\")+1),$scope.$digest()}}}}])}();