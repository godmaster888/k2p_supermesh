"use strict";function schedulerServise(translate,$state,navigation,pageList,conf,device){function getFullLink(rule,indexesLink,dynamicLink){function getLink(link,indexes,dynamicLink){var result="";return _.isArray(link)?_.each(link,function(item,i){result+=item+indexes[i]+"."}):result=_.isFunction(link)?link(dynamicLink)+indexes[0]+".":link+indexes[0]+".",result}if(schedulerSupported){var result,itemConf=_.findWhere(configPages,{rule:rule});return itemConf&&(result=getLink(itemConf.Link,indexesLink,dynamicLink)),result?result:null}}var schedulerSupported=!!autoconf.BR2_PACKAGE_ANWEB_DSYSINIT,configPages=function(config){if(schedulerSupported){config=function(conf){var result=[];return _.mapObject(conf,function(arr){result=result.concat(arr)}),result}(config);var result=[];return _.each(config,function(item){pageList[item.pageName]&&(_.each(navigation,function(nav,i){var findedPage,arrPaths,namePath,currentPath;_.isObject(nav.page)&&(findedPage=_.find(nav.page,function(page){return page===item.pageName})),nav.page&&(nav.page===item.pageName||findedPage)&&(item.href=i,arrPaths=i.split("."),namePath=[],currentPath="",_.each(arrPaths,function(path){currentPath.length&&(currentPath+="."),currentPath+=path,navigation[currentPath].menu&&namePath.push(navigation[currentPath].menu.name)}),item.Name=namePath.join("/"))}),result.push(item))}),result}}(conf);return{translateSchedule:function(str){var arrStr=str.split(" "),result=[],regDateDay=/^([0-9]{1,})([A-z]+)/,regTime=/^[0-9]{1,2}(:[0-9]{2}){1,3}$/,regComma=/(.+)(\,)$/,regLastCount=/^\([0-9]+\)$/;return _.each(arrStr,function(item){var num=regDateDay.exec(item),comma=regComma.exec(item);comma&&(item=comma[1]),num?"D"==num[2]||"H"==num[2]||"M"==num[2]||"S"==num[2]?(num[2]="units_dt_"+num[2],result.push(num[1]+""+translate(num[2]))):result.push(num[1]+""+translate("sched_"+num[2])):result.push(regTime.test(item)||regLastCount.test(item)||!isNaN(item)?item:translate("sched_"+item)),comma&&(result[result.length-1]+=",")}),function(str){return str=str.replace(/^\s*/,""),str.charAt(0).toUpperCase()+str.slice(1)}(result.join(" ").toLowerCase())},getTask:function(link,rule){function findPage(page){var strRegExp;strRegExp=_.isFunction(page.Link)?page.Link():_.isArray(page.Link)?page.Link.join("\\w+."):page.Link,strRegExp+="\\d+.",strRegExp=strRegExp.replace(/\./g,"\\.").replace(/undefined/g,"\\w+");var regexp=new RegExp(strRegExp);return regexp.test(link)}var translatePath,page,result={};return rule&&(page=_.findWhere(configPages,{rule:rule})),page||(page=_.find(configPages,findPage)),page&&(translatePath=page.Name.split("/"),translatePath=_.map(translatePath,function(item){return translate(item)}),result.Name=translatePath.join("/"),result.href=page.href),result},checkPageSchedulerSupported:function(rule){return schedulerSupported?_.findWhere(configPages,{href:$state.current.name,rule:rule}):!1},getFullLink:getFullLink,isSupport:schedulerSupported,getSchedulerData:function(){return device.schedule.pull()},isExists:function(rule,indexesLink,dynamicLink){var link=getFullLink(rule,indexesLink,dynamicLink);return device.schedule.existsLink(link)},addRuleNamesToTasks:function(rules,data,ruleName,indexesNames){function getLinks(item,rule,indexesNames){function getIndexes(item,indexesNames){var indexFirst,result=[],indexes=_.map(indexesNames,function(indexName){return _.isFunction(indexName)?indexName(item):item[indexName]});return _.isArray(indexes[1])?(indexFirst=indexes[0],_.each(indexes[1],function(indexSecond){result.push([indexFirst,indexSecond])})):result.push(indexes),result}var indexesLink,result=[];return item.Origin?result.push(item.Origin):(indexesLink=getIndexes(item,indexesNames),_.each(indexesLink,function(indexes){return result.push(getFullLink(rule,indexes))})),result}var links;return data&&(links=[],_.isArray(data)?_.each(data,function(item){links=links.concat(getLinks(item,ruleName,indexesNames))}):links=links.concat(getLinks(data,ruleName,indexesNames)),_.each(links,function(link){link&&_.each(rules,function(rule){_.each(rule.genInfo.tasks,function(task){task.Link===link&&(task.rule=ruleName)})})})),rules},parseIndexesLink:function(indexes){var result=[];return _.isArray(indexes[0])?_.each(indexes[0],function(indexFirst,inx){var indexSecond=indexes[1][inx];_.isArray(indexSecond)?_.each(indexSecond,function(index){result.push([indexFirst,index])}):result.push([indexFirst,indexSecond])}):result.push(indexes),result}}}var scheduler=angular.module(regdep("scheduler"),[]);scheduler.factory("scheduler",["translate","$state","navigation","pageList","schedulerConfig","device",schedulerServise]);