"use strict";!function(){var nw=angular.module(regdep("nw-textarea"),[]);nw.directive("nwTextarea",["translate","$compile",function(translate,$compile){return{restrict:"A",replace:!0,scope:{nwModel:"=",nwLabel:"@",nwLabelStatusText:"@",nwLabelStatusValue:"@",nwReadonly:"@"},template:'<div class="div_textarea"><span class="label" ng-class="{ required: isRequired }"></span><span class="label {{ nwLabelStatusValue }}" ng-if="nwLabelStatusText">{{ nwLabelStatusText}}</span><textarea class="nw_textarea" ng-model="nwModel" ng-change="getChange(nwModel)" ng-readonly="nwReadonly"></textarea><span class=\'label\'></span><div class="nwfield_valid"><span ng-class="error" ng-show="isShowError()"></span></div></div>',link:function($scope,$element,$attr){function getAdditionalInfo(value){var smsCountStr,maxSmsLength;return void 0!=$attr.nwTextareaSmsCount?0==value.length?"":(smsCountStr="",maxSmsLength=new RegExp("[А-яЁё]+","g").test(value)?70:135,smsCountStr=" ("+Math.floor(1+value.length/maxSmsLength)+" SMS)"):""}function getTextByteSize(value){var textSize=0,maxInx=0;return _.each(value,function(char,inx){textSize+=getCharSize(char),textSize>=maxTextLength&&(maxInx||(maxInx=inx))}),textSize}function getCharSize(char){var code=char.charCodeAt(0);return code>=0&&127>=code?1:code>=128&&2047>=code?2:code>=2048&&65535>=code?3:code>=65536&&2097151>=code?4:1}function checkTextareaRequired(){$scope.isRequired&&isVisible(textarea[0])?model.$setValidity("msg_input_is_empty",!isModelEmpty()||model.$pristine):model.$setValidity("msg_input_is_empty",!0)}function isModelEmpty(){return _.isUndefined(model.$viewValue)||_.isNaN(model.$viewValue)||_.isNull(model.$viewValue)||!model.$viewValue.toString().length}function isVisible(dom){return dom&&"none"!=dom.style.display&&dom.offsetWidth&&dom.offsetHeight}function isFuncsAttr(attr){return/\(.*\)$/.test(attr)}var rowsCount,maxTextLength,lastLength,countStr,simpleCountStr,textarea=$element.find("textarea"),label=$element.find("span").eq(0),textError=$element.find("span").eq(2),lengthError=!1,$textarea=angular.element(textarea),$model=$textarea.data("$ngModelController");$scope.$watch(function(){return $model.$modelValue},function(){$scope.getChange($scope.nwModel)}),$scope.isRequired=$scope.nwRequired||""===$attr.nwRequired,$attr.nwLabel&&(isFuncsAttr($attr.nwLabel)?label.attr("ng-bind",""+$attr.nwLabel):label.attr("ng-bind","'"+$attr.nwLabel+"' | translate"),$compile(label)($scope)),textError.attr("ng-bind","'voip_textmsg_msg_more_than_max_length'| translate"),$compile(textError)($scope),$attr.nwTextareaPlaceholder&&textarea.attr("placeholder",translate($attr.nwTextareaPlaceholder)),$attr.nwTextareaMaxlength&&(maxTextLength=parseInt($attr.nwTextareaMaxlength)),void 0!=$attr.nwTextareaCount&&void 0!=$attr.nwTextareaMaxlength&&(countStr=$element.find("span").eq(1),countStr.attr("ng-bind","'"+translate("voip_textmsg_count_left")+": {{"+maxTextLength+"}}' | translate"),$compile(countStr)($scope)),void 0!=$attr.nwTextareaSimpleCount&&(simpleCountStr=$element.find("span").eq(1),simpleCountStr.attr("ng-bind","'"+translate("Введено символов")+": {{0}}' | translate"),$compile(simpleCountStr)($scope)),$attr.nwTextareaRows?textarea.attr("rows",$attr.nwTextareaRows):$attr.nwTextareaMaxlength?(rowsCount=parseInt($attr.nwTextareaMaxlength/100),textarea.attr("rows",10>rowsCount?rowsCount:10)):textarea.attr("rows",3),$scope.getChange=function(value){var curLength;if(void 0!=$attr.nwTextareaSimpleCount){if(!simpleCountStr)return;simpleCountStr.attr("ng-bind","'"+translate("usb_modem_sms_enteded_characters")+": {{"+value.length+"}}"+getAdditionalInfo(value)+"'"),$compile(simpleCountStr)($scope)}if(void 0!=$attr.nwTextareaCount){if(!countStr)return;curLength=getTextByteSize(value),lastLength=maxTextLength-curLength,lengthError=0>lastLength?!0:!1,model.$setValidity("maxLength",!lengthError),countStr.attr("ng-bind","'"+translate("voip_textmsg_count_left")+": {{"+lastLength+"}}' | translate"),$compile(countStr)($scope)}},$scope.isShowError=function(){return lengthError};var model=textarea.data("$ngModelController");model&&$scope.isRequired&&$scope.$watch("nwModel",checkTextareaRequired)}}}])}();