"use strict";!function(){var modname="ping-traceroute-flow";window.appDeps.push(modname);var app=autoconf.BR2_PACKAGE_ANWEB_DSYSINIT?angular.module(modname,["device-monitor"]):angular.module(modname,[]);app.service("pingTracerouteFlow",["$rootScope","$timeout",function($rs,$timeout){return{start:function(load,flowDetector,$scope){function open(connection){connection.__status=!0,keepAlive(connection)}function close(connection){connection.__status=!1,connection.close()}function keepAlive(connection){connection.__status&&(connection.send("ping"),$timeout(keepAlive.bind(null,connection),2e3))}function handler(connection,input,flowDetector){if(!input||input.error)return flowDetector.error(),void close(connection);if(input.result){if(input.result.end)return flowDetector.close(),void close(connection);flowDetector.add(input.result.message)}}var proto="https:"==document.location.protocol?"wss":"ws",connection=new WebSocket(proto+"://"+document.location.host+"/websocket");return connection.onopen=function(){var send="init "+Math.round(4294967294*Math.random()+1);connection.send(send),open(connection),connection.send("sysutils:"+load)},connection.onerror=function(error){$rs.deviceMonitor.availability?flowDetector.close():flowDetector.error(error),close(connection)},connection.onmessage=function(e){var load,input,data=e.data;"sysutils:"==data.substring(0,9)&&(load=data.replace("sysutils:",""),input=JSON.parse(load),handler(connection,input,flowDetector))},$scope.$on("$destroy",function(){return close(connection)}),{close:close.bind(null,connection)}}}}])}();