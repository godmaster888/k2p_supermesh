"use strict";!function(){angular.module("app").service("dynPortMappingUtil",["cpe","device","funcs",function(cpe,device,funcs){function apply(rule){rule.Mode=config.Mode;var data=converter.nativeToDsysinit(rule),initRule=funcs.fetchBranch(__initConfig,paths.portMapping+rule.__index+".");initRule=initRule?funcs.setValue(paths.portMapping+rule.__index,initRule,{}):{};var diff=funcs.newConfig.makeDiff(initRule,data,__initAttrs);return _.isEmpty(diff)?Promise.resolve():(activate=!1,cpe.ApplyDifference(diff))}function getMode(){return config?config.Mode:""}function getConfig(){return config?config:[]}function getAttrs(){return attrs?attrs:{}}function removeRules(indexes){var newConfig=funcs.deepClone(__initConfig);_.each(indexes,function(index){funcs.cutBranch(newConfig,paths.portMapping+index)});var diff=funcs.newConfig.makeDiff(__initConfig,newConfig,__initAttrs);return cpe.ApplyDifference(diff)}function wasActivate(){return activate}function getRule(inx){return config&&config.Rules[inx]?config.Rules[inx]:{}}function getDefault(){return defaultRule?defaultRule:{}}var config=null,attrs=null,__initConfig=null,__initAttrs=null,activate=!1,defaultRule=null,converter=device.dynPortMapping.converter,paths={network:"Device.Network.",portMapping:"Device.Services.DynamicPortMapping.",mode:"Device.DeviceInfo.DeviceMode",usbConns:"Device.USB.Connection."};return{pull:function(){var configPaths=[paths.network,paths.portMapping,paths.mode];return configPaths.push(paths.usbConns),Promise.all([cpe.GetParameterValues(configPaths),cpe.GetParameterAttributes([paths.portMapping])]).then(function(response){var data=funcs.buildTree(response[0].result.ParameterList),dataAttr=funcs.buildTreeAttributes(response[1].result.ParameterList);return __initConfig=funcs.deepClone(data),__initAttrs=funcs.deepClone(dataAttr),config=converter.dsysinitToNative(data),attrs=converter.attrs(dataAttr,data),defaultRule=converter.defaultRule(dataAttr),activate=!0,Promise.resolve()},function(){return Promise.reject()})},apply:apply,getConfig:getConfig,getAttrs:getAttrs,removeRules:removeRules,getRule:getRule,getDefault:getDefault,getMode:getMode,wasActivate:wasActivate}}])}();