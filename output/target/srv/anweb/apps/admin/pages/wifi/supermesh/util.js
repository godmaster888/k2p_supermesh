"use strict";!function(){angular.module("app").service("wifiSuperMeshUtil",["funcs","device","cpe","devinfo","translate","ngDialog",function(funcs,device,cpe,devinfo,translate){function getData(freq){return config?_.find(config.Radio,{Band:freq}):{}}function getBands(){var bands=config?_.pluck(config.RadioBands,"Band"):[];if(!bands.length)return[];var result=[];return _.contains(bands,"2.4GHz")&&result.push("2.4GHz"),_.contains(bands,"5GHz")&&result.push("5GHz"),result}function getRadioBands(freq){return _.find(config.RadioBands,{Band:freq})}function translateTypes(neighbours){return _.each(neighbours,function(nbr){var types=nbr.NeighbourType.split("/");types=_.map(types,function(elem){return translate(elem)}),nbr.NeighbourType=types.join("/")}),neighbours}function push(){function prepareDiff(diff){var currentDiff=funcs.deepClone(diff);if(!_.has(currentDiff.Device.WiFi,"Radio"))return currentDiff;var isDelete=null,radio=null,memberDelete=null,bridge=null;if(_.each(currentDiff.Device.WiFi.Radio,function(elem,key){_.each(elem.SuperMeshPoint,function(point,id){~id.indexOf("-")&&(isDelete=id,radio=key)})}),currentDiff.Device.Network&&_.each(currentDiff.Device.Network.Interface.Bridge,function(elem,key){_.each(elem.Members,function(memeber,id){~id.indexOf("-")&&(memberDelete=id,bridge=key)})}),!isDelete||!radio)return currentDiff;var result={};return funcs.setValue("Device.WiFi.Radio."+radio+".SuperMeshPoint."+isDelete,currentDiff.Device.WiFi.Radio[radio].SuperMeshPoint[isDelete],result),funcs.cutBranch(currentDiff,"Device.WiFi.Radio."+radio+".SuperMeshPoint."),memberDelete&&bridge&&(funcs.setValue("Device.Network.Interface.Bridge."+bridge+".Members."+memberDelete,currentDiff.Device.Network.Interface.Bridge[bridge].Members[memberDelete],result),funcs.cutBranch(currentDiff,"Device.Network.Interface.Bridge."+bridge+".Members."+memberDelete+".")),[result].concat(currentDiff)}var data=converter.nativeToDsysinit(config),initData=converter.nativeToDsysinit(__initNativeConfig),diff=funcs.newConfig.makeDiff(initData,data,attrs);return _.isEmpty(diff)?Promise.resolve():(diff=prepareDiff(diff),cpe.ApplyDifference(diff))}function supportedParam(param,subPath){var root=subPath?subPath:"",attr=funcs.fetchBranch(attrs,"Device.WiFi.SuperMeshProfile.#template.");return _.has(attr[root],param)}function notEnable(freq){var radios=_.filter(config.Radio,function(e){return e.Band!=freq});return _.some(radios,function(radio){return radio.Enable})}var config={},attrs=null,__initNativeConfig=null,freq=null,converter=device.wifiSupermesh.converter,configPath=["Device.Network.Interface.","Device.WiFi.SuperMeshProfile.","Device.WiFi.Radio.1.","Device.Statistics.WiFi.Radio.1.SuperMeshPoint.","Device.DeviceInfo.DeviceMode"];return configPath.push("Device.WiFi.Radio.2.","Device.Statistics.WiFi.Radio.2.SuperMeshPoint."),{pull:function(){function success(response){config=funcs.buildTree(response[0].result.ParameterList),attrs=funcs.buildTreeAttributes(response[1].result.ParameterList),angular.copy(config);var input={data:config,attrs:attrs};return config=converter.dsysinitToNative(input),_.each(config.Radio,function(radio){radio.StatisticNeighbours=translateTypes(radio.StatisticNeighbours)}),__initNativeConfig=angular.copy(config),config.Radio=config.Radio?config.Radio:"1",Promise.resolve()}return Promise.all([cpe.GetParameterValues(configPath),cpe.GetParameterAttributes(configPath)]).then(success,function(){return Promise.reject()})},push:push,getData:getData,getBands:getBands,getRadioBands:getRadioBands,supportedParam:supportedParam,subscribeInfo:function(cb,$scope){function prepareData(response){var resp,input,data;response&&(resp=[],_.each(response,function(item,key){var split;"infoAreasStatus"!=key&&(split=funcs.splitTree(item),resp=resp.concat(split))}),input={data:funcs.buildTree(resp)},data=converter.dsysinitToNative(input),_.each(data.Radio,function(radio){radio.StatisticNeighbours=translateTypes(radio.StatisticNeighbours)}),cb&&cb(_.find(data.Radio,{Band:freq})))}var subscribeString=configPath.join("|");devinfo.subscribe(subscribeString,prepareData,$scope)},notEnable:notEnable,setFreq:function(inputFreq){freq=inputFreq}}}])}();