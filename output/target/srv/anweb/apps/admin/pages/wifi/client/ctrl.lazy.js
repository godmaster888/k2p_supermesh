"use strict";!function(){angular.module("app").controllerProvider.register("wifiClientCtrl",["$scope","$state","$q","$location","$rootScope","translate","ngDialog","devinfo","$timeout","wifiClientUtil","cookie","lanHelper",function($scope,$state,$q,$location,$rootScope,translate,ngDialog,devinfo,$timeout,util,cookie,lanHelper){function activate(){Promise.all([pullClient(),pullSchedule()]).then(function(){activateRadio(),activateAP(),activateClient(),checkWDSActivate(),$scope.meshNoteParams={mode:'<a href="#/wifi/supermesh?freq='+$scope.band.state+'">'+translate("wifi_mesh_function")+"</a>",trustAsHtml:!0},$scope.isWDSActivate||($scope.isActivate=!0),$scope.$emit("pageload")})["catch"](pullError)}function activateRadio(){device.wifi.hasBand("2.4GHz")&&($scope.radio=device.wifi.getBand(0,"2.4GHz").radio),device.wifi.hasBand("5GHz")&&($scope.radio5G=device.wifi.getBand(0,"5GHz").radio)}function activateAP(){device.wifi.hasBand("2.4GHz")&&($scope.ap=device.wifi.getBand(0,"2.4GHz").ap.getBase()),device.wifi.hasBand("5GHz")&&($scope.ap5G=device.wifi.getBand(0,"5GHz").ap.getBase())}function checkWDSActivate(){var wds=device.wifi.getWDSData();$scope.isWDSActivate=wds&&"Disabled"!=wds.Mode}function pullClient(){var deferred=$q.defer();return device.wifi.pullClient(function(error){if(error)return void deferred.reject(error);$scope.isSeparateClient=device.wifi.isSeparateClient(),$scope.bandParams={},$scope.warnings.length=0;var clientBands=device.wifi.getClientBands();$scope.isSeparateClient?($scope.band.list.length||($scope.band.list=clientBands),$scope.band.state||($scope.band.state=$state.params.freq?$state.params.freq:_.first($scope.band.list))):clientBands.length>1&&($scope.needShowFrequency=!0),device.wifi.hasBand("2.4GHz")||($scope.bandParams["2.4GHz"]="unsupported"),device.wifi.hasBand("5GHz")||($scope.bandParams["5GHz"]="unsupported"),device.wifi.hasBand("2.4GHz")&&!device.wifi.isRadioEnable("2.4GHz")&&($scope.bandParams["2.4GHz"]="disabled",$scope.warnings.push(device.wifi.hasBand("5GHz")?"radio_24GHz_disabled":"radio_disabled")),device.wifi.hasBand("5GHz")&&!device.wifi.isRadioEnable("5GHz")&&($scope.bandParams["5GHz"]="disabled",$scope.warnings.push("radio_5GHz_disabled")),deferred.resolve($scope.bandParams)}),deferred.promise}function pullSchedule(){var deferred=$q.defer();return device.schedule.pull().then(function(error){if(error)return void deferred.reject(error);var inx24=null,inx5=null,band24=device.wifi.getBand(0,"2.4GHz");band24&&(inx24=band24.radio.Inx);var band5=device.wifi.getBand(0,"5GHz");band5&&(inx5=band5.radio.Inx);var link="Device.WiFi.Radio.",linkBroadcast24=link+inx24+".AccessPoint.\\d+.",linkBroadcast5=link+inx5+".AccessPoint.\\d+.",linkBand24=link+inx24+".",linkBand5=link+inx5+".";inx24&&device.schedule.existsLink(linkBroadcast24)&&$scope.warnings.push("exists_schedule_broadcast_24"),inx5&&device.schedule.existsLink(linkBroadcast5)&&$scope.warnings.push("exists_schedule_broadcast_5"),inx24&&device.schedule.existsLink(linkBand24)&&$scope.warnings.push("exists_schedule_radio_24"),inx5&&device.schedule.existsLink(linkBand5)&&$scope.warnings.push("exists_schedule_radio_5"),deferred.resolve()}),deferred.promise}function pullScan(){var deferred=$q.defer();$scope.wifiClient.scanLoading=!0;var band=$scope.band.state?$scope.band.state:"2.4GHz";return util.pullScan(band,$scope).then(function(data){data&&device.wifi.updateScan(data),$scope.wifiClient.scanLoading=!1,deferred.resolve()}),deferred.promise}function pullError(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"}),$scope.$emit("pageload")}function activateClient(){updateClientData(),$scope.ep.ConnectMode="select",$scope.ep.sortDirection="desc",$scope.ep.sortActive="SignalStrength"}function activateScanList(){$scope.wifiClient.scanList=device.wifi.scanList($scope.band.state),$scope.sortBy($scope.ep.sortActive)}function startUpdateClientStatus(data){_.isObject(data)?($scope.ep.Connect=data.Connect,$scope.ep.data.RSSI=data.RSSI,$scope.ep.data.Channel=data.Channel):$scope.ep.Connect=data}function updateScanList(){return $scope.wifiClient.scanLoading?void 0:pullScan().then(activateScanList)}function updateClientData(){var band=$scope.band.state?$scope.band.state:"2.4GHz";$scope.client=device.wifi.getClient(band),$scope.ep.data=$scope.client.getBase(),$scope.ep.Connect=!!$scope.ep.data.Connect,$scope.ep.data.Enable&&$scope.ep.data.SSID&&""!=$scope.ep.data.SSID&&util.startUpdateClientStatus(startUpdateClientStatus,$scope),onEnable($scope.ep.data.Enable)}function isDefinitelyOpenedInMobileAppByDomainName(){return $rootScope.dlinkMobileApp.isUserInMobileApp()&&$rootScope.dlinkMobileApp.customLocalDomainCheck?$rootScope.dlinkMobileApp.isDomainNameUsing():Promise.resolve(!1)}function changeConnectMode(value){"manual"==value?($scope.backupTemplate=angular.copy($scope.ep.data),$scope.ep.data.Security.DefaultKeyID||($scope.ep.data.Security.DefaultKeyID="1"),$scope.ep.data.Security.EncryptionType||($scope.ep.data.Security.EncryptionType="None"),encryptWatcher=$scope.$watch($scope.getEncrypTypes,changeEncrypType,!0)):(_.extend($scope.ep.data,angular.copy($scope.backupTemplate)),$scope.backupTemplate=null,encryptWatcher&&encryptWatcher())}function changeEncrypType(types){if(types&&$scope.ep.data){var encr=$scope.ep.data.Security.EncryptionType;_.contains(types,encr)||($scope.ep.data.Security.EncryptionType=types[0])}}function showDialog(){return ngDialog.open({template:"/admin/dialogs/wifi_enable_autochannel/dialog.tpl.html",controller:"WiFiAutochannelCtrl",scope:$scope})}function checkConns(){return util.checkConns($scope.ep.data.Interface).then(function(data){return data&&data.length?($scope.overlayApply.stop($scope.overlayApplyId),alert(translate("vlan_need_remove_conns")+": "+data.join(", ")),Promise.reject()):Promise.resolve()})}function applySettings(settings){settings&&_.extend($scope.ep.data,settings),$scope.$emit("unsavewWarningStopWatch");var overlay=$scope.overlay.circular,overlayId=overlay.start();device.wifi.push(function(error){error?$state.go("error",{code:"msg_push_error",message:"msg_error_desc"}):$state.go($state.current,{},{reload:!0})})["finally"](overlay.stop.bind(overlay,overlayId)),$scope.$emit("pageload")}function isFormInvalid(){return $scope.form&&$scope.form.$invalid}function infoDialog(band,settings){return ngDialog.open({template:"/admin/dialogs/wifi_client_change_standart/dialog.tpl.html",controller:"WiFiClientChangeStandartCtrl",scope:$scope,data:{band:band,settings:settings}})}function closeInfoDialog(res){res&&res.value&&"save"==res.value.action&&("2.4GHz"==$scope.ep.data.Band?$scope.radio.OperatingStandards="bg":$scope.radio5G.OperatingStandards="a",applySettings(res.value.settings))}function separatedWarnDialog(band){return ngDialog.open({template:"/admin/dialogs/wifi_client_separated_warning/dialog.tpl.html",controller:"WiFiClientSeparatedWarnCtrl",scope:$scope,data:{band:band}})}function closeSeparatedWarnDialog(res){res&&res.value&&"canсel"==res.value.action&&($scope.ep.data.Enable=!1)}function onEnable(){isAPMode&&$scope.ep.data.Enable&&$scope.isSeparateClient&&$scope.needShowSeparatedWarning()&&separatedWarnDialog($scope.band.state).closePromise.then(closeSeparatedWarnDialog),$scope.ep.data.Enable&&updateScanList()}var hiddenTimeout,device=$scope.device,helper=device.wifi.helper,isAPMode="ap"===cookie.get("device_mode");$scope.isActivate=!1,$scope.isWDSActivate=!1,$scope.client=null,$scope.radio=null,$scope.radio5G=null,$scope.ap=null,$scope.ap5G=null,$scope.ep={},$scope.backup={},$scope.onEnable=onEnable,$scope.needShowFrequency=!1,$scope.wifiClient24Enable=!1,$scope.wifiClient5Enable=!1,$scope.needShowSeparatedWarning=!1,$scope.needShowApSettingsWarning=!0,$scope.warnings=[],$scope.hasWarning=function(name){return name?_.contains($scope.warnings,name):$scope.warnings.length},$scope.enableRadio=function(band){device.wifi.enableRadio(band,activate)},$scope.showButtonBlock=function(){return!!_.intersection($scope.warnings,["radio_disabled","radio_24GHz_disabled","radio_5GHz_disabled"]).length},$scope.band={list:[],state:null,change:function(freq){if(!isFormInvalid()){if($scope.wasModifed())return void $state.go($state.current,{freq:freq},{reload:!0});$scope.wifiClient.changingBand=!0,$timeout(function(){$scope.wifiClient.changingBand=!1},100),$scope.band.state=freq,updateClientData(),activateScanList(),$state.go(".",{freq:freq},{notify:!1})}}},$scope.wifiClient={updateScanList:updateScanList,isSelectMode:function(){var band=$scope.band.state;return band?device.wifi.hasBand(band)&&device.wifi.isRadioEnable(band):!0},scanList:[],selectEndpoint:function(index){function startConnectionDialog(){startDialog(options).closePromise.then(closeDialog)}function startWarningDialog(options){return ngDialog.open({template:"/admin/dialogs/wifi_client_device_loss_warning/dialog.tpl.html",controller:"WifiClientDeviceLossCtrl",scope:$scope,data:options})}function startDialog(options){return ngDialog.open({template:"/admin/dialogs/wifi_client/dialog.tpl.html",controller:"WifiClientDialogCtrl",scope:$scope,data:options})}function closeDialog(result){var dataRadio,bandRadio;result&&result.value&&(result.value.radio&&(dataRadio=result.value.radio,bandRadio="5GHz"==dataRadio.Band?$scope.radio5G:$scope.radio,dataRadio.Channel&&(bandRadio.AutoChannelEnable=!1,bandRadio.Channel=dataRadio.Channel)),$scope.apply(result.value.ep))}function closeWarningDialog(result){var host,value=result?result.value:void 0;value&&(value.goToDomainName?(host=$scope.apModeInfo.localHostname,$rootScope.dlinkMobileApp.isUserInMobileApp()&&$rootScope.dlinkMobileApp.ipAddressChangedAdvanced({disconnect:!1,save:!0,address:host}),$rootScope.goToNewIP(host)):value.goToLanSettings?$state.go("network.lan"):($scope.needShowApSettingsWarning=!result.value.notAskAgain,value["continue"]&&startConnectionDialog()))}angular.copy($scope.wifiClient.scanList[index]);var options={pointData:angular.copy($scope.wifiClient.scanList[index]),clientData:angular.copy($scope.ep.data)};(function(){var apModeInfo=$scope.apModeInfo;return $scope.needShowApSettingsWarning&&apModeInfo&&apModeInfo.apMode&&apModeInfo.dynamicIpAvailable&&(!apModeInfo.dynamicAddressingMode||!apModeInfo.localDomainLoaded&&(!$rootScope.dlinkMobileApp.isUserInMobileApp()||$rootScope.dlinkMobileApp.hasAdvancedIpAddressChanged))})()?startWarningDialog({apModeData:angular.copy($scope.apModeInfo)}).closePromise.then(closeWarningDialog):startConnectionDialog()},getSelectedClass:function(item){var ep=$scope.ep.data;return ep?_.isUndefined(ep.BSSID)?"":_.isEmpty(ep.BSSID)&&ep.SSID==item.SSID&&ep.Band==item.Band&&ep.Channel==item.Channel&&ep.Security.ModeEnabled==item.ModeEnabled&&ep.Security.EncryptionType==item.EncryptionType?"selected-main":ep.BSSID.toUpperCase()==item.BSSID.toUpperCase()&&ep.Band==item.Band?"selected-main":"":""}},$scope.$on("$destroy",function(){hiddenTimeout&&$timeout.cancel(hiddenTimeout)}),activate(),function(){var supported=lanHelper.supported.lan();Promise.all([function(){var deferred=$q.defer();return $scope.device.lan.pull(function(error){return error?void deferred.reject("pull"):void deferred.resolve()},supported),deferred.promise}(),isDefinitelyOpenedInMobileAppByDomainName()]).then(function(results){var supportedIPv4=lanHelper.supported.ipv4(),ipv4data=$scope.device.lan.data()[1].IPv4;$scope.apModeInfo={dynamicIpAvailable:supportedIPv4.AddressingModeAvailable.includes("Dynamic"),apMode:supportedIPv4.AddressingMode,dynamicAddressingMode:"Dynamic"===ipv4data.AddressingMode,dhcpEnabled:"Disable"!==ipv4data.DHCP.Mode,localHostname:ipv4data.StaticIP[1].AddnHostname,localDomainLoaded:results[1]||$location.$$host===ipv4data.StaticIP[1].AddnHostname}},function(e){console.log(e)})}(),$scope.supportedBroadcast=function(freq){var ap="2.4GHz"==freq?$scope.ap:$scope.ap5G;return ap&&_.has(ap,"Broadcast")},$scope.supportedMacAddressClone=function(){return!1},$scope.disabledMacAddressClone=function(){return $scope.ap&&$scope.ap.Broadcast?!0:$scope.ap5G&&$scope.ap5G.Broadcast?!0:!1},$scope.showBroadcast=function(freq){return $scope.band.state?$scope.band.state==freq:!0},$scope.enableBroadcast=function(){$scope.supportedMacAddressClone()&&$scope.disabledMacAddressClone()&&($scope.ep.data.MacAddressClone.Mode="off",$scope.ep.data.MacAddressClone.Address="")},$scope.supportedParam=function(obj,param){return obj&&void 0!=obj[param]},$scope.sortBy=function(field){$scope.wifiClient.scanList.sort(function(field){return function(x,y){var ep=$scope.ep.data;if(ep.BSSID&&x.BSSID.toLowerCase()===ep.BSSID.toLowerCase())return-1;if(ep.BSSID&&y.BSSID.toLowerCase()===ep.BSSID.toLowerCase())return 1;if(_.isEmpty(ep.BSSID)){if(ep.SSID==x.SSID&&ep.Band==x.Band&&ep.Channel==x.Channel&&ep.Security.ModeEnabled==x.ModeEnabled&&ep.Security.EncryptionType==x.EncryptionType)return-1;if(ep.SSID==y.SSID&&ep.Band==y.Band&&ep.Channel==y.Channel&&ep.Security.ModeEnabled==y.ModeEnabled&&ep.Security.EncryptionType==y.EncryptionType)return 1}return"Channel"==field||"SignalStrength"==field?parseInt(x[field])<parseInt(y[field])?1:-1:x[field].toLowerCase()<y[field].toLowerCase()?1:-1}}(field))},$scope.getSecurityInfo=function(security){var result="",mode=security.ModeEnabled;switch(mode){case"None":case"WEP":result+="Open";break;case"WPA-Enterprise":result+="WPA";break;case"WPA2-Enterprise":result+="WPA2";break;case"WPA-WPA2-Enterprise":result+="WPA/WPA2 mixed";break;case"WPA-Personal":result+="WPA-PSK";break;case"WPA2-Personal":result+="WPA2-PSK";break;case"WPA-WPA2-Personal":result+="WPA-PSK/WPA2-PSK mixed";break;case"WPA3":result+="WPA3-SAE";break;case"WPA2-WPA3":result+="WPA2-PSK/WPA3-SAE mixed";break;default:result+="UNKNOWN"}return result},$scope.getNotAvailStatus=function(){if(0==$scope.wifiClient.scanList.length)return"";var availNet=_.find($scope.wifiClient.scanList,function(elem){return elem.BSSID==$scope.ep.data.BSSID&&elem.Band==$scope.ep.data.Band});return availNet?"":" ("+translate("wifi_client_out_of_range")+")"},$scope.getFreq=function(band){return"2.4GHz"==band?translate("24ghz"):"5GHz"==band?translate("5ghz"):""},$scope.get24GHzLablelName=function(){var translatedKey=translate("wifi_broadcast");return translatedKey+" 2.4 "+translate("units_GHz")},$scope.get5GHzLablelName=function(){var translatedKey=translate("wifi_broadcast");return translatedKey+" 5 "+translate("units_GHz")};var encryptWatcher;$scope.$watch("ep.ConnectMode",changeConnectMode),$scope.supportedModes=function(){var ModesTemplate=function(){return[{name:"Open",value:"None"},{name:"WEP",value:"WEP"},{name:"WPA-PSK",value:"WPA-Personal"},{name:"WPA2-PSK",value:"WPA2-Personal"},{name:"WPA-PSK/WPA2-PSK mixed",value:"WPA-WPA2-Personal"},{name:"WPA3-SAE",value:"WPA3"},{name:"WPA2-PSK/WPA3-SAE mixed",value:"WPA2-WPA3"}]}(),ModesSupported=$scope.ep.data.Security.ModesSupported.split(",");return _.filter(ModesTemplate,function(obj){return _.indexOf(ModesSupported,obj.value)+1?!0:!1})},$scope.getDefaultKeysID=function(){return helper.getDefaultKeysID()},$scope.getEncrypTypes=function(){return helper.getEncrypTypesClient($scope.ep.data)},$scope.showSecurity=function(type){return helper.checkSecurityType(type,$scope.ep.data)},$scope.validPSKKey=function(pskKey){return helper.validPSKKey(pskKey)},$scope.radiusLengthValidation=function(radiusParam,paramIdent){return helper.validRadiusParamLen(radiusParam,paramIdent)},$scope.getWEPKeyLenMessage=function(){return $scope.ep?helper.getWEPKeyLenMessage($scope.ep.data):null},$scope.validWEPKey=function(wepKey){return $scope.ep?helper.validWEPKey(wepKey,$scope.ep.data):null},$scope.apply=function(settings){if(!isFormInvalid()){var openwep,modeEnabled,encrType=settings?settings.Security.EncryptionType:$scope.ep.data.Security.EncryptionType,bandRadio="2.4GHz"==$scope.ep.data.Band?$scope.radio:$scope.radio5G;("WEP"==encrType||"NONE"==encrType)&&(openwep=settings?settings.Security.OpenWEP:$scope.ep.data.Security.OpenWEP,modeEnabled=settings?settings.Security.ModeEnabled:$scope.ep.data.Security.ModeEnabled,encrType=modeEnabled&&"WEP"==modeEnabled?"WEP":openwep?"WEP":"NONE"),$scope.ep.data.Enable&&!util.checkEncryptionType($scope.ep.data.Band,bandRadio.OperatingStandards,encrType)?infoDialog($scope.ep.data.Band,settings).closePromise.then(closeInfoDialog):$scope.ep.data.Enable?applySettings(settings):($scope.overlayApply=$scope.overlay.circular,$scope.overlayApplyId=$scope.overlayApply.start(),checkConns().then(function(){bandRadio.AutoChannelEnable?($scope.overlayApply.stop($scope.overlayApplyId),applySettings(settings)):($scope.overlayApply.stop($scope.overlayApplyId),showDialog().closePromise.then(function(result){result&&result.value&&"enable"==result.value.action&&(bandRadio.AutoChannelEnable=!0),applySettings(settings)}))}))}},$scope.getSeparatedWarning=function(){return"5GHz"==$scope.band.state?"wifi_client_separated_warn24":"wifi_client_separated_warn5"},$scope.needShowSeparatedWarning=function(){if(!isAPMode)return!1;var endPoint=$scope.radio&&$scope.radio.EndPoint&&_.first(_.map($scope.radio.EndPoint)),endPoint5G=$scope.radio5G&&$scope.radio5G.EndPoint&&_.first(_.map($scope.radio5G.EndPoint));return endPoint&&endPoint5G&&($scope.wifiClient24Enable=endPoint.Enable,$scope.wifiClient5Enable=endPoint5G.Enable),"5GHz"==$scope.band.state&&$scope.wifiClient24Enable||"2.4GHz"==$scope.band.state&&$scope.wifiClient5Enable},$scope.wasModifed=function(){return $scope.isActivate&&device.wifi.isChange()}}])}();