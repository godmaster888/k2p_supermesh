"use strict";!function(){angular.module("app").controllerProvider.register("EoIPRuleCtrl",["$scope","$state","funcs","devinfo","EoIPUtil","translate",function($scope,$state,funcs,devinfo,util){function wasModified(){return __initialRule&&!_.isEqual(__initialRule,angular.copy(eoip.rule))}var __initialRule=null,index=_.isUndefined($state.params.inx)?void 0:parseInt($state.params.inx),currentState=$state.current.name.split(".");currentState.pop(),currentState=currentState.join("."),$scope.eoipRule={isActivate:!1,rule:null,connList:null,lans:null,apply:function(){function success(){$state.go(currentState+".info")}if(!$scope.form.$invalid){var overlay=$scope.overlay.circular,overlayId=overlay.start(),applyObj=util.applyRule(eoip.rule,index);applyObj?util.apply(applyObj).then(success)["catch"](function(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})})["finally"](overlay.stop.bind(overlay,overlayId)):success()}},wasModified:wasModified,validation:function(value,type){if(""==value)return null;switch(type){case"PeerIP":if(!funcs.is.ipv4(value))return"msg_invalid_ipv4";if(_.contains(eoip.lans,value))return"apps_partner_ip_is_router_ip";if(!util.checkUnique(value,index,type))return"msg_error_value_is_not_uniq";break;case"Name":if(!util.checkUnique(value,index,type))return"msg_error_value_is_not_uniq";if(value.length>32)return"msg_invalid_name_length";break;case"TunnelID":if(!util.checkUnique(value,index,type))return"msg_error_value_is_not_uniq"}return null}};var eoip=$scope.eoipRule;!function(){function __activate(){eoip.action=_.isUndefined(index)?"add":"edit",eoip.rule=util.getRule(index),(eoip.rule.KeepaliveInterval>0||eoip.rule.KeepaliveRetries>0)&&($scope.eoipRule.keepalive=!0),devinfo.once("net").then(function(data){eoip.lans=_.pluck(data.lan,"ip")}),eoip.connList=util.getConnList(),__initialRule=angular.copy(eoip.rule),eoip.isActivate=!0,$scope.$emit("pageload")}function errorPull(){$state.go("error",{code:"msg_error_pull",message:"msg_error_desc"})}util.getActivate()?__activate():util.pull().then(__activate)["catch"](errorPull)}(),$scope.$watch("eoipRule.keepalive",function(enabled){eoip.rule&&!enabled&&(eoip.rule.KeepaliveInterval=0,eoip.rule.KeepaliveRetries=0),eoip.rule&&enabled&&0==eoip.rule.KeepaliveInterval&&0==eoip.rule.KeepaliveRetries&&(eoip.rule.KeepaliveInterval=5,eoip.rule.KeepaliveRetries=5)})}])}();