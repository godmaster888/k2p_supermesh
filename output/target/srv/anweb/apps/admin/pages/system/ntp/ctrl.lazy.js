"use strict";!function(){angular.module("app").controllerProvider.register("SysNtpCtrl",["$scope","$state","systemNtpUtil","funcs","snackbars","SysNtpConstants","translate",function($scope,$state,util,funcs,snackbars,constants,translate){function init(){function success(){helper=util.makeHelper(),systemTime.data=helper.getData(),splitDSTData(systemTime.data.ntp.DSTStart,"Start"),splitDSTData(systemTime.data.ntp.DSTEnd,"End"),systemTime.data.ntp.DSTTimeZoneOffset=autoconf.BR2_PACKAGE_ANWEB_DSYSINIT?void 0:systemTime.data.ntp.DSTTimeZoneOffset,systemTime.data.TimeZoneIndex=-1,systemTime.data.DSTTimeZoneIndex=autoconf.BR2_PACKAGE_ANWEB_DSYSINIT?void 0:-1,systemTime.timeStamp=helper.getTimeStamp(systemTime.data.time);var lastServer=_.last(systemTime.data.ntp.Servers);systemTime.id=lastServer&&lastServer.__id||0,systemTime.options={years:_.range(1970,2038),months:_.range(1,13),weeks:_.range(1,6),weekDays:constants.weekDays,days:_.range(1,32),hours:_.range(24),dstHours:getDstHours(),mins:_.range(60),timezones:getTimeZones(),DstTimezones:getDSTTimeZones(),pollInterval:autoconf.BR2_PACKAGE_ANWEB_DSYSINIT?helper.getPoolIntervalEnum():void 0,retryInterval:helper.getRetryIntervalEnum()},__backup=funcs.deepClone(systemTime.data),$scope.$watch("systemTime.time.Year",changeDaysRange),$scope.$watch("systemTime.time.Month",changeDaysRange),util.subscribeTime(function(time){systemTime.timeStamp=helper.getTimeStamp(time)},$scope)}util.pull().then(success)["catch"](function(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"})})["finally"]($scope.$emit.bind($scope,"pageload"))}function apply(){if(!$scope.ntpSettings.$invalid){unionDSTData();var config=helper.formConfig(systemTime.data);if(config.Device.Services.NTP.Enable&&_.isEmpty(config.Device.Services.NTP.Servers)&&!config.Device.Services.NTP.DHCPServers)return void alert(translate("ntp_empty_ntp_server"));var overlay=$scope.overlay.circular,overlayId=overlay.start();util.apply(config).then(function(){snackbars.add("msg_apply_success"),init()})["catch"](function(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})})["finally"](overlay.stop.bind(overlay,overlayId))}}function unionDSTData(){var dst;_.has(systemTime.data,"DST")&&(dst=systemTime.data.DST,systemTime.data.ntp.DSTStart="M"+dst.StartMonth+"."+dst.StartWeek+"."+dst.StartWeekDays.value+"/"+dst.StartHour,systemTime.data.ntp.DSTEnd="M"+dst.EndMonth+"."+dst.EndWeek+"."+dst.EndWeekDays.value+"/"+dst.EndHour)}function splitDSTData(data,point){function getWeekDay(day){return _.findWhere(constants.weekDays,{value:day})}var arr,arr2;data&&(arr=data.split("/"),arr2=arr[0].split("."),systemTime.data.DST=systemTime.data.DST||{},systemTime.data.DST[point+"Hour"]=arr[1],systemTime.data.DST[point+"Month"]=Number(arr2[0].split("M")[1]),systemTime.data.DST[point+"Week"]=Number(arr2[1]),systemTime.data.DST[point+"WeekDays"]=getWeekDay(arr2[2]))}function deteremineTimezone(){var offset=(100*-((new Date).getTimezoneOffset()/60)/100).toFixed(2),arrOffset=offset.split(".");systemTime.data.ntp.TimeZoneOffset=helper.unionOffset(arrOffset[0],arrOffset[1])}function changeDaysRange(optionYear,optionMonth){var time=systemTime.data.time,year=optionYear?optionYear:time.Year,month=optionMonth?optionMonth:time.Month;systemTime.options.days=_.range(1,function(year,month){return new Date(year,month,0).getDate()}(year,month)+1);var lastDay=function(){return systemTime.options.days.slice(-1)[0]}();time.Day>lastDay&&(time.Day=lastDay)}function getTimeZones(){function getSign(zone){return"-"==zone.offset[0]?"-":"+"}return[{name:translate("ntp_change_main"),index:-1}].concat(_.map(constants.zones,function(zone,index){return{index:index,sign:getSign(zone),name:zone.name,offset:zone.offset}}))}function getDSTTimeZones(){function getSign(zone){return"-"==zone.offset[0]?"-":"+"}return[{name:translate("ntp_change_summer"),index:-1}].concat(_.map(constants.zones,function(zone,index){return{index:index,sign:getSign(zone),name:zone.name,offset:zone.offset}}))}function getDstHours(){var i,hours=[];for(i=0;24>=i;i++)hours.push(10>i?"0"+i+":00":i+":00");return hours}function wasModified(){return __backup&&!funcs.deepEqual(__backup,systemTime.data)}$scope.systemTime={data:null,id:0,timeStamp:null,options:null,apply:apply,addServer:function(){$scope.systemTime.focus=!0,systemTime.data.ntp.Servers.push({address:"",__id:++systemTime.id})},removeServer:function(inx){systemTime.data.ntp.Servers.splice(inx,1)},deteremineTimezone:deteremineTimezone,setLocalTime:function(){var local=new Date,time=systemTime.data.time;time.Year=local.getFullYear(),time.Month=local.getMonth()+1,time.Day=local.getDate(),time.Hour=local.getHours(),time.Minute=local.getMinutes()},isShowServerList:function(){return systemTime.data&&systemTime.data.ntp.Enable&&!systemTime.data.ntp.DHCPServers},isSupportedNtp:function(param){return systemTime.data&&_.has(systemTime.data.ntp,param)},wasModified:wasModified,formatGMT:function(offset){return offset?"00:00"==offset?"GMT":"GMT"+offset:""},noteGMT:function(offset){return _.filter(constants.zones,function(zone){return offset==zone.offset})},validation:function(address,id){var check=_.some(systemTime.data.ntp.Servers,function(elem){return address&&address==elem.address&&id!=+elem.__id&&!elem.isDynamic?!0:null});return check?"msg_error_value_is_not_uniq":null},changeRetryType:function(){systemTime.data.ntp.RetryInterval=0==systemTime.data.ntp.RetryType?0:""},isDynamicCheck:function(){return systemTime.data.ntp.Servers.some(function(o){return o.isDynamic})}};var helper,systemTime=$scope.systemTime,__backup=null;init(),$scope.$watch("systemTime.data.TimeZoneIndex",function(value){value>=0&&(systemTime.data.ntp.TimeZoneOffset=systemTime.options.timezones[value+1].offset,systemTime.data.TimeZoneIndex=-1)}),$scope.$watch("systemTime.data.DSTTimeZoneIndex",function(value){value>=0&&(systemTime.data.ntp.DSTTimeZoneOffset=systemTime.options.timezones[value+1].offset,systemTime.data.DSTTimeZoneIndex=-1)}),$scope.$watch("systemTime.data.time.Month",function(value){value&&changeDaysRange(null,value)}),$scope.$watch("systemTime.data.time.Year",function(value){value&&changeDaysRange(value,null)}),$scope.checkFirefoxVersion=function(){return/Firefox\/5./.test(navigator.userAgent)?"padding-top-dateTimeBlock":void 0}}])}();