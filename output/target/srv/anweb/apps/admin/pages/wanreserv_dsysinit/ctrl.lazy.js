"use strict";!function(){angular.module("app").controllerProvider.register("WanReservCtrl",["$scope","$state","translate","funcs","snackbars","WanReservUtil","ngDialog",function($scope,$state,translate,funcs,snackbars,util,ngDialog){function activate(){util.pull().then(function(){wanreserv.data=util.getConfig(),__backup=angular.copy(wanreserv.data),wanreserv.isActivate=!0,$scope.$emit("pageload")})["catch"](function(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"})})}function wasModified(){function checkModifiedHosts(hosts1,hosts2){if(hosts1=angular.copy(hosts1),hosts2=angular.copy(hosts2),hosts1.length!=hosts2.length)return!0;var isHostModified=!1;for(var key in hosts1)hosts1[key].Value!=hosts2[key].Value&&(isHostModified=!0);return isHostModified}if(!__backup||!wanreserv.data)return null;var elem,connCheckElem,checkConfig=angular.fromJson(angular.toJson(wanreserv.data)),isModified=!1;for(var key in checkConfig)if(elem=checkConfig[key],elem instanceof Object){if("ConnCheck"==key)for(var inst in elem)connCheckElem=elem[inst],"MinMax"!=inst&&(isModified="Hosts"==inst?isModified||checkModifiedHosts(connCheckElem,__backup[key][inst]):isModified||connCheckElem!=__backup[key][inst]);if("Connections"==key)for(var type in elem)for(var inst in elem[type])(elem[type][inst].Name!=__backup[key][type][inst].Name||elem[type][inst].Check!=__backup[key][type][inst].Check)&&(isModified=!0)}else elem!=__backup[key]&&(isModified=!0);return isModified}function getStatus(item){return translate(item?"on":"off")}$scope.wanreserv={isActivate:!1,data:null,apply:function(){if(!$scope.form.$invalid){var overlay=$scope.overlay.circular,overlayId=overlay.start();util.apply(wanreserv.data).then(function(){snackbars.add("msg_apply_success"),activate()})["catch"](function(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})})["finally"](overlay.stop.bind(overlay,overlayId))}},isSupported:function(param){return wanreserv.data&&util.isSupported(param)},removeHost:function(index){wanreserv.data.ConnCheck.Hosts.splice(index,1)},addHost:function(){wanreserv.data.ConnCheck.Hosts.push({Value:""})},hasConnections:function(){return wanreserv.data&&wanreserv.data.Connections&&wanreserv.data.Connections.IPv4&&wanreserv.data.Connections.IPv4.length},getTimeLabel:function(name){return"ms"==wanreserv.data.TimeSystem&&(name+="_ms"),translate(name)},wasModified:wasModified,getConnsTitle:function(version){return translate("connections")+" "+version},disableRemoveHost:function(){return 1==wanreserv.data.ConnCheck.Hosts.length},checkHost:function(host,index){if(!host)return null;if(!funcs.is.ipv4(host))return"msg_invalid_ipv4";if("0.0.0.0"==host||"255.255.255.255"==host)return"msg_invalid_host";var hostList=funcs.deepClone(wanreserv.data.ConnCheck.Hosts);void 0!=index&&hostList.splice(index,1);var isNotUniqueHost=!1;for(var key in hostList)key!=index&&hostList[key].Value==host&&(isNotUniqueHost=!0);return isNotUniqueHost?"msg_error_value_is_not_uniq":null},checkRecheckTimeout:function(){var config=wanreserv.data.ConnCheck;if(void 0!=config.PingRetries)return null;var minValue=Math.ceil(config.PingRetries*config.PingTimeout/1e3);return config.RecheckTimeout-1<minValue?translate("wanreserv_recheck_timeout_less_min")+" "+minValue:null},getMiniTableShort:function(item){return translate("wanreserv_conn_check")+": "+getStatus(item.Check)},editConn:function(item,key,type){ngDialog.open({template:"dialogs/wanreserv_dsysinit/dialog.tpl.html",controller:"WanReservDialogCtrl",data:{item:item,key:key,lastKey:wanreserv.data.Connections[type].length-1},scope:$scope}).closePromise.then(function(response){var elem;response&&response.value&&"change"==response.value.status&&(wanreserv.data.Connections[type][key].Check=response.value.data.Check,key!=response.value.data.Key&&(elem=funcs.deepClone(wanreserv.data.Connections[type][key]),wanreserv.data.Connections[type].splice(key,1),wanreserv.data.Connections[type].splice(response.value.data.Key,0,elem)))})},getStatus:getStatus,getEmptyAlert:function(){return translate("connects_empty_message",{name:"IPv4"})}};var wanreserv=$scope.wanreserv,__backup=null;activate()}])}();