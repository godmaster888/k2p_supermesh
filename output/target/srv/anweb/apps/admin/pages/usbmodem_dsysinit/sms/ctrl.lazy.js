"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}!function(){angular.module("app").controllerProvider.register("USBModemSMSCtrl",["$scope","$state","translate","USBModemUtil","ngDialog","funcs","detectLang",function($scope,$state,translate,util,ngDialog,funcs,detectLang){function activate(){function init(){if($scope.sms.data=util.getModem(modem),$scope.sms.activeSim=_.find($scope.sms.data.SIM,{__inx:$scope.sms.data.ActiveSIM}),!$scope.sms.activeSim)return $scope.sms.needSIM=!0,$scope.sms.isActivate=!0,void $scope.$emit("pageload");checkSIM(),setSmsMemory($scope.sms.activeSim.SMS),$scope.sms.needPIN||$scope.sms.notInserted||!$scope.sms.data.Power||getMessageList().then(readMessages)["catch"](errorPull);var currentParam=$state.params.param?$state.params.param:_.first($scope.sms.Param.List).Value;$scope.sms.Param.State=currentParam,util.subscribeSMSInfo(updateInfo,$scope,"Device.USB.Modem."+modem+"."),$scope.sms.isActivate=!0,$scope.$emit("pageload")}function errorPull(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"}),$scope.$emit("pageload")}util.isActivate()?init():util.pull(modem).then(init)["catch"](errorPull)}function readMessages(response){function prepareMessages(messageList,type){function getFormatDate(date){var dateSplit=date.split(" "),data=dateSplit[0].split("."),month=getMonth(data[1]);return month+" "+data[0]+", "+data[2]+" "+dateSplit[1]}function getMonth(month){switch(month){case"01":return"January";case"02":return"February";case"03":return"March";case"04":return"April";case"05":return"May";case"06":return"June";case"07":return"July";case"08":return"August";case"09":return"September";case"10":return"October";case"11":return"November";case"12":return"December"}}var messages=_.where(messageList,{Box:type}),result=_.map(messages,function(elem){var indexes=_.map(funcs.newConfig.normalize(elem.Index),function(obj){return obj.Value});return _defineProperty({Number:elem.Number,Status:elem.Status,Text:elem.Text,Indexes:indexes,Date:"In"==type?elem.Date:void 0,FormatDate:"In"==type?getFormatDate(elem.Date):void 0},"Status",elem.Status)});return result.sort(function(a,b){return new Date(b.FormatDate)-new Date(a.FormatDate)})}var messageList=funcs.buildTree(response.result.ParameterList);$scope.sms.MessageList.In=prepareMessages(messageList.List,"In"),$scope.sms.MessageList.Out=prepareMessages(messageList.List,"Out")}function checkSIM(){_.has($scope.sms.activeSim,"PIN")&&($scope.sms.needPIN="PIN"==$scope.sms.activeSim.PIN.Status||"PUK"==$scope.sms.activeSim.PIN.Status?$scope.sms.activeSim.PIN.Status:null),$scope.sms.notInserted=!$scope.sms.activeSim.Inserted}function setSmsMemory(smsMemory){$scope.sms.SmsMemory.Unread=smsMemory.Unread,$scope.sms.SmsMemory.InCount=-1!=smsMemory.Read&&-1!=smsMemory.Unread?smsMemory.Read+smsMemory.Unread:"-",$scope.sms.SmsMemory.OutCount=-1!=smsMemory.Sent&&-1!=smsMemory.Unsent?smsMemory.Sent+smsMemory.Unsent:"-",$scope.sms.SmsMemory.AllCount="-"!=$scope.sms.SmsMemory.InCount&&"-"!=$scope.sms.SmsMemory.OutCount?$scope.sms.SmsMemory.InCount+$scope.sms.SmsMemory.OutCount:"-",$scope.sms.SmsMemory.StorageCapacity=-1!=smsMemory.StorageCapacity?smsMemory.StorageCapacity:void 0,$scope.sms.SmsMemory.UsedMemory=(-1!=smsMemory.StorageUsed?smsMemory.StorageUsed:"-")+"/"+(-1!=smsMemory.StorageCapacity?smsMemory.StorageCapacity:"-"),$scope.sms.SmsMemory.FullMemory=-1!=smsMemory.StorageUsed&&-1!=smsMemory.StorageCapacity?smsMemory.StorageUsed==smsMemory.StorageCapacity:!1}function updateInfo(result){$scope.sms.data.Power="Removed"!=result.State,setSmsMemory(result.SIM[$scope.sms.activeSim.__inx].SMS.Statistics)}function loadParam(param){var simIndex,newHref,paramArr,nowHref=location.href.split("#")[1],freqArr=nowHref.split("&");if(freqArr.length>1){simIndex=_.findIndex(freqArr,function(elem){return~elem.indexOf("param=")}),freqArr[simIndex]="param="+param.Value;var newHref=freqArr.join("&")}else if(paramArr=nowHref.split("?"),paramArr[1]&&-1!=paramArr[1].indexOf("modem"))var newHref=nowHref+"&param="+param.Value;else paramArr[1]="param="+param.Value,newHref=paramArr.join("?");location.href="#"+newHref}function getLink(){return"#/usbmodem/basic?modem="+modem}function getMessageList(){var input={modem:modem,sim:$scope.sms.activeSim.__inx};return util.getMessages(input)}function entryPin(){ngDialog.open({template:"/admin/dialogs/usbmodem_dsysinit/entry_pin/dialog.tpl.html",controller:"EntryPinCtrl",data:{data:{pin:$scope.sms.activeSim.PIN,modem:modem,sim:$scope.sms.activeSim.__inx}},scope:$scope}).closePromise.then(function(data){data.value&&data.value.success&&activate()})}function addMessage(number,text){ngDialog.open({template:"/admin/dialogs/usbmodem_dsysinit/send_sms/dialog.tpl.html",controller:"SendMessageCtrl",data:{data:{Number:number||"",Text:text||"",modem:modem,sim:$scope.sms.activeSim.__inx,limit:$scope.sms.SmsMemory.StorageCapacity?$scope.sms.SmsMemory.StorageCapacity-$scope.sms.SmsMemory.AllCount:void 0}}}).closePromise.then(function(data){data.value&&data.value.success})}function removeMessage(items){var input={modem:modem,sim:$scope.sms.activeSim.__inx,items:items};util.removeMessages(input).then(refresh,errorPush)}function refresh(){var overlay=$scope.overlay.circular,overlayId=overlay.start();getMessageList().then(readMessages)["finally"](overlay.stop.bind(overlay,overlayId))}function errorPush(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"}),$scope.$emit("pageload")}function changePowerMode(){ngDialog.open({template:"/admin/dialogs/usbmodem_dsysinit/change_power_mode/dialog.tpl.html",controller:"USBModemChangePowerCtrl",data:{path:"Device.USB.Modem."+$scope.sms.data.__inx+".State",power:!0},scope:$scope}).closePromise.then(activate)}var modem=$state.params.modem,lang=detectLang();$scope.sms={data:null,activeSim:null,MessageList:{In:[],Out:[]},isActivate:!1,activeModem:null,needPIN:null,needSIM:!1,notInserted:!1,getLink:getLink,getModemsList:function(){return util.getModemsList()},entryPin:entryPin,FilterList:[{Name:"usb_modem_sms_msg_filter_in",Value:"In"},{Name:"usb_modem_sms_msg_filter_out",Value:"Out"}],Filter:"In",addMessage:addMessage,removeMessage:removeMessage,isDisabledAnswerButton:function(number){var regexp=/^([\+]?\d+|[\*\#\d]+)$/g;return!number||regexp.test(number)?!1:!0},refresh:refresh,changeModem:function(key){modem=key,activate()},showDateTime:function(date){if(!date)return"-";var locale="rus"==lang?"ru":"en-US";return date.toLocaleString(locale,{year:"numeric",montg:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"})},enablePower:function(){util.powerChange("on",$scope.sms.data.__inx).then(changePowerMode)["catch"](function(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})})},getStatusText:function(status){return translate("usb_modem_sms_status_"+status.toLowerCase())}},$scope.sms.Param={List:[{Name:"usb_modem_sms_nav",Value:"sms"},{Name:"usb_modem_sms_memory_title",Value:"settings"}],State:null,change:function(param){$scope.sms.Param.State=param,loadParam(param),$state.go(".",{param:param},{notify:!1})},load:loadParam},$scope.sms.SmsMemory={FullMemory:!1,InCount:null,OutCount:null,AllCount:null,UsedMemory:null,Unread:0},activate()}])}();