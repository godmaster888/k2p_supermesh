"use strict";angular.module("app").controller("WanInfoAdvancedCtrl",["$scope","$state","translate","wanPageCommon","wanPage",function($scope,$state,translate,wanPageCommon,wanPage){function getBreakMsgRemove(conns){var alrt,alrtConnCount,alertConns=[];conns.filter(function(e){return e.reserve});var msg;if(alertConns.length){msg=translate("wan_delete_conn_err")+" ("+alertConns.map(function(alrt){return alrt.conn})+").";for(var i in alertConns)alrt=alertConns[i],alrtConnCount=alrt.conn.split(",").length,msg+=alrtConnCount>1?"\n"+translate("connections")+" ("+alrt.conn+") "+alrt.msg+".":"\n"+translate("connection")+" ("+alrt.conn+") "+alrt.msg+"."}return msg}function getConfirmMsgRemove(conns){var alrt,connCount,alertConns=[],gateways=conns.filter(function(e){return e.gwif}).map(function(e){return e.name});gateways.length&&alertConns.push(gateways.length>1?{conn:gateways.join(", "),msg:translate("wan_default_gateway_warning_connections2")}:{conn:gateways.join(", "),msg:translate("wan_default_gateway_warning_connection2")});var trConn=conns.find(function(e){return e.tr});trConn&&alertConns.push({conn:trConn.name,msg:translate("wan_tr_warning")});var voipConn=conns.find(function(e){return e.voip});voipConn&&alertConns.push({conn:voipConn.name,msg:translate("wan_voip_warning")});var msg="",allAlertConnCount=0,allAlertConnNames=[];if(alertConns.length)for(var i in alertConns)alrt=alertConns[i],connCount=alrt.conn.split(",").length,allAlertConnCount+=connCount,allAlertConnNames=allAlertConnNames.concat(alrt.conn.split(", ")),msg+=connCount>1?translate("connections")+" ("+alrt.conn+") "+alrt.msg+".\n":translate("connection")+" ("+alrt.conn+") "+alrt.msg+".\n";return msg+=translate(allAlertConnCount>1&&_.uniq(allAlertConnNames).length>1?"wan_connections_warning":"wan_connections_warning_one")}$scope.simpleModeAvail=$state.params.simpleModeAvail,$scope.data=$state.params.data;var igmpNav,href,name,flatConnList=$scope.data.__flatConnList,getTypeLangKey=wanPageCommon.getTypeLangKey;$scope.list=flatConnList.map(function(e,i,all){var typeText=translate(getTypeLangKey(e,e.__Type)),ifaceText=wanPageCommon.getIfaceText(e,all),statusText=wanPage.getStatusText($scope.data,e),strStatusText=wanPageCommon.getStrStatusText(statusText),status=wanPageCommon.getStatus(statusText),ret={name:e.Name,type:typeText,iface:ifaceText,status:status,statusText:strStatusText,shortInfo:typeText+"/"+ifaceText,path:e.__Path,gwif:e.DefaultGateway||e.DefaultGatewayv6,tr:wanPage.wanUsedInTr69($scope.data,e),voip:wanPage.wanUsedInVoIP($scope.data,e),reserve:wanPage.wanUsedInReserve($scope.data,e)};return ret}).sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0}),$scope.pageDetails.igmp&&(igmpNav=$scope.pageDetails.igmp[0],href=igmpNav.url,name=translate(igmpNav.menu.name),$scope.igmpDesc=translate("igmp_wan_desc",{link:"<a href='"+href+"'>"+name+"</a>",trustAsHtml:!0})),$scope.switchToSimpleMode=function(){$scope.$emit("switchWanPageMode",!1)},$scope.reconnect=function(conns){var paths=conns.map(function(e){return e.path}),overlay=$scope.overlay.circular.start();wanPage.reconnect(paths,$scope.data).then(function(){$scope.$emit("pageNeedUpdate")})["catch"](function(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})})["finally"](function(){$scope.overlay.circular.stop(overlay)})},$scope.remove=function(conns){var breakMsg=getBreakMsgRemove(conns);if(breakMsg)return void alert(breakMsg);var confirmMsg=getConfirmMsgRemove(conns);if(!confirmMsg||confirm(confirmMsg)){var paths=conns.map(function(e){return e.path}),overlay=$scope.overlay.circular.start();wanPage.remove(paths,$scope.data).then(function(){$scope.$emit("pageNeedUpdate")})["catch"](function(){$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})})["finally"](function(){$scope.overlay.circular.stop(overlay)})}},$scope.edit=function(item){$scope.$emit("goToEditing",item.path)},$scope.add=function(){$scope.$emit("goToAdding")}}]);