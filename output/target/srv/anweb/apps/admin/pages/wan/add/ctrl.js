"use strict";angular.module("app").controller("WanAddCtrl",["$scope","$state","wanPage","wanPageCommon","ngDialog","translate","$q",function($scope,$state,wanPage,wanPageCommon,ngDialog,translate,$q){function completeConnectionData(conn,simple){var baseConns,baseConnsv6,deferred=$q.defer();if("PPTP"==conn.__Type||"IPv4oE"==conn.__Type&&"L2TPv3"==conn.MediaType||"IPIP6"==conn.__Type){var baseConns=wanPageCommon.flattenConnections(priv.data,!1,["IPv4oE","USB"]).filter(function(e){return!e.InterfaceOnly}).map(function(e){return{data:e}});baseConnsv6=wanPageCommon.flattenConnections(priv.data,!1,["IPv6oE"]).map(function(e){return{data:e}}),ngDialog.open({template:"dialogs/wan_additional_connection/pptp/dialog.tpl.html",controller:"WanAdditionalConnectionPPTPDialogCtrl",scope:$scope,data:{useAuto:priv.data.UseAutomaticalPPTP,connections:simple?[]:"IPIP6"==conn.__Type?baseConnsv6:baseConns,type:conn.__Type},trapFocus:!1,preserveFocus:!1}).closePromise.then(function(result){setTimeout(function(){var baseConn;result&&result.value&&"new"==result.value.mode||"auto"==result.value.mode&&"IPIP6"==conn.__Type&&!result.value.connection?("IPv4oE"==conn.__Type&&deferred.resolve({action:"continue"}),priv.baseConn="IPIP6"==conn.__Type?wanPageCommon.getNewConnTempl(priv.data,"dynipv6"):wanPageCommon.getNewConnTempl(priv.data,"dynip"),priv.mainConn.BaseConnection="Device.WAN."+priv.baseConn.__Path,"IPIP6"==conn.__Type&&"auto"==result.value.mode&&(conn.AutomaticalConnection=!0),deferred.resolve({action:"new",role:"base",contype:"IPIP6"==conn.__Type?"dynipv6":"dynip",availableTypes:"IPIP6"==conn.__Type?wanPage.availableTypesForBaseIPIP6():wanPage.availableTypesForBasePPTP()})):result&&result.value&&"auto"==result.value.mode&&"IPIP6"!=conn.__Type?(conn.AutomaticalConnection=!0,deferred.resolve({action:"continue"})):(result&&result.value&&"select"==result.value.mode||"auto"==result.value.mode&&"IPIP6"==conn.__Type&&null!=result.value.connection)&&(("PPTP"==conn.__Type||"IPIP6"==conn.__Type)&&(baseConn=result.value.connection.data,priv.mainConn.BaseConnection="Device.WAN."+baseConn.__Path),"IPIP6"==conn.__Type&&"auto"==result.value.mode&&(conn.AutomaticalConnection=!0),deferred.resolve({action:"continue"}))},0)})}else"PPPoE"==conn.__Type&&simple?(baseConns=wanPageCommon.flattenConnections(priv.data,!1,["IPv4oE"]).map(function(e){return{data:e}}),ngDialog.open({template:"dialogs/wan_additional_connection/pppoe/dialog.tpl.html",controller:"WanAdditionalConnectionPPPoEDialogCtrl",scope:$scope}).closePromise.then(function(result){setTimeout(function(){priv.mainConn.DefaultGateway=!0,"accept"==result.value?(priv.baseConn=wanPageCommon.getNewConnTempl(priv.data,"dynip"),deferred.resolve({action:"new",role:"base",contype:"dynip",availableTypes:[{name:"dynip",value:"dynip"},{name:"statip",value:"statip"}]})):"skip"==result.value&&deferred.resolve({action:"continue"})},0)})):deferred.resolve({action:"continue"});return deferred.promise}function setFlagIGMP(data,allConns,conflicts){var conn,contype,list=wanPageCommon.flattenConnections(data);for(var i in list)conn=list[i],contype=wanPageCommon.getContype(conn,conn.__Type),conn.Flags.IGMP=wanPageCommon.getFlagIGMP(contype,allConns,conflicts)}var priv={baseStateName:$state.current.name,connStateName:$state.current.name+".conn",contype:$state.params.contype||"dynip",dataToConvert:{}};wanPage.pull().then(function(data){return priv.data=data,priv.mainConn=wanPageCommon.getNewConnTempl(data,priv.contype),$state.go(priv.connStateName,{data:priv.data,conn:priv.mainConn,_contype:priv.contype,role:"main"})}).then(function(){$scope.$emit("pageload")})["catch"](function(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"})}),$scope.$on("contypeChange",function($event,contype,role){"main"==role?$state.params.contype?$state.go(priv.baseStateName,{contype:contype}):(priv.mainConn=wanPageCommon.getNewConnTempl(priv.data,contype),$state.go(priv.connStateName,{data:priv.data,conn:priv.mainConn,_contype:contype,role:"main"})):"base"==role&&(priv.baseConn=wanPageCommon.getNewConnTempl(priv.data,contype),priv.mainConn.BaseConnection="Device.WAN."+priv.baseConn.__Path,$state.go(priv.connStateName,{data:priv.data,conn:priv.baseConn,_contype:contype,availableTypes:"IPIP6"==priv.mainConn.__Type?wanPage.availableTypesForBaseIPIP6():wanPage.availableTypesForBasePPTP(),role:"base"}))}),$scope.$on("pagesubmit",function($event,conn,simple){wanPageCommon.getOrCreateByPath(conn.__Path,priv.dataToConvert,conn),completeConnectionData(conn,simple).then(function(result){var conflicts,overlay,types=["PPPoE","PPPoEv6","PPPoEDual","PPPoA","PPTP","3G","LTE","IPoA","Bridge","USB","IPIP6"],connections=Object.keys(priv.dataToConvert);if(_.find(connections,function(c){return _.contains(types,c)}),conflicts=simple?wanPageCommon.flattenConnections(priv.data).map(function(e){return e.__Path}):wanPageCommon.getConflictingConnections(conn,priv.data).map(function(e){return e.__Path}),conflicts.length&&setFlagIGMP(priv.dataToConvert,priv.data.__flatConnList,conflicts),!conflicts.length||simple||confirm(translate("wan_overwriting_wan_connection_warning"))){if("continue"==result.action)return overlay=$scope.overlay.circular.start(),wanPage.push(priv.dataToConvert,conflicts,priv.data).then(function(){return wanPageCommon.goToWanMainState()})["catch"](function(error){return error?void $state.go("error",{code:"msg_push_error",message:"msg_error_desc"}):wanPageCommon.goToWanMainState()})["finally"](function(){$scope.overlay.circular.stop(overlay)});"new"==result.action&&$state.go(priv.connStateName,{data:priv.data,conn:priv.baseConn,_contype:result.contype,availableTypes:result.availableTypes,role:result.role}).then(function(){$scope.$emit("pageload")})}else priv.dataToConvert={}})})}]);