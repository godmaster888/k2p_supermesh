"use strict";!function(){angular.module("app").controllerProvider.register("IPsecRuleCtrl",["$scope","$rootScope","$state","funcs","translate","history","IPsecUtil","ngDialog",function($scope,$rootScope,$state,funcs,translate,history,util,ngDialog){function checkUniqueAndLength(ruleName,length){return helper.checkUnique(ruleName,__index)?ruleName&&ruleName.length>length?translate("msg_maxlength_symb")+" "+length:null:"msg_error_value_is_not_uniq"}function apply(){function success(){overlay.stop(overlay,overlayId),$state.go(currentState+".info")}if(!$scope.form.$invalid){if("transport"!=ipsec.rule.type&&!ipsec.rule.nets.length)return void alert(translate("ipsec_warning_nets_empty"));if(isDupAnonymous())return void alert(translate("ipsec_anonymous_exist"));if(isIpVersionChanged())return void alert(translate("ipsec_warning_nets_ip_version"));var overlay=$scope.overlay.circular,overlayId=overlay.start();!function(){0==ipsec.rule.enableDPD&&(ipsec.rule.dpd_delay=0,ipsec.rule.dpd_maxfail=0,ipsec.rule.dpd_timeout=0),2==ipsec.rule.version&&_.has(ipsec.rule,"aggressive")&&null!=ipsec.rule.aggressive&&(ipsec.rule.aggressive=!1)}();var applyObj=helper.applyRule(ipsec.rule,__index);applyObj?util.apply(applyObj).then(success)["catch"](function(){overlay.stop(overlay,overlayId),$state.go("error",{code:"msg_push_error",message:"msg_error_desc"})}):success()}}function remove(){var removeConnections=helper.removeRules([__index]),overlay=$scope.overlay.circular,overlayId=overlay.start();util.apply(removeConnections).then(function(){history.setCleanLastHistory(!0),$state.go(currentState+".info")},function(){$state.go("error",{code:"removeError",message:"removeErrorDesc"})})["finally"](overlay.stop.bind(overlay,overlayId))}function getList(param){switch(param){case"left_iface":return[{name:translate("st_not_selected"),value:""}].concat(helper.getList(param,ipsec.rule,$scope.ipVersion.value));case"left_group":return[{name:translate("st_not_selected"),value:""}].concat(helper.getList(param,ipsec.rule));case"left_type":return"Firewall"!=ipsec.rule.devMode?[{name:translate("interface"),value:"iface"},{name:translate("default_gateway"),value:"group"}]:[{name:translate("interface"),value:"iface"},{name:translate("wan_group"),value:"group"}];default:return helper.getList(param,ipsec.rule)}}function getFilterList(param,rule){return util.wasActivate()?helper.getFilterList(param,rule):[]}function removeNets(items,indexes){_.each(items,function(item){item.index&&ipsec.rule.delete_nets.push(item.index)});var indexes=indexes.sort().reverse();_.each(indexes,function(ind){ipsec.rule.nets.splice(ind,1)})}function showNetsDialog(options){var inx=options.inx;options.list=angular.copy(ipsec.rule.nets),options.data.ipVersion=$scope.ipVersion.value,_.has(options,"inx")&&options.list.splice(inx,1),function(options){return ngDialog.open({template:"dialogs/ipsec_nets_form/dialog.tpl.html",controller:"IPsecNetsFormDialogCtrl",resolve:funcs.getLazyResolve("dialogs/ipsec_nets_form/ctrl.lazy.js","IPsecNetsFormDialogCtrl"),scope:$scope,data:options})}(options).closePromise.then(function(result){var value;result&&result.value&&(value=result.value,_.has(value,"write")&&(_.isUndefined(inx)?ipsec.rule.nets.push(value.write):ipsec.rule.nets[inx]=value.write),_.has(value,"remove")&&removeNets(value.remove.items,value.remove.index))})}function isDupAnonymous(){if(ipsec.rule.anonymous){var tunnels=helper.getTunnels();return _.some(tunnels,function(tunnel){return tunnel.anonymous&&__index!=tunnel.__index})}}function isIpVersionChanged(){var changed=!1;return(ipsec.rule.nets[0].ipVersion&&$scope.ipVersion.value!=ipsec.rule.nets[0].ipVersion||"ipv4"==$scope.ipVersion.value&&!funcs.is.ipv4(ipsec.rule.nets[0].source.split("/")[0])||"ipv6"==$scope.ipVersion.value&&!funcs.is.ipv6(ipsec.rule.nets[0].source.split("/")[0]))&&(changed=!0),changed}function wasModified(){function checkModifiedNets(nets1,nets2){return nets1=angular.copy(nets1),nets2=angular.copy(nets2),nets1.length!=nets2.length?!0:_.some(nets1,function(v,k){return!_.isEqual(v,nets2[k])})}return ipsec.rule&&__backupRule&&_.keys(ipsec.rule).length!=_.keys(__backupRule).length||_.some(ipsec.rule,function(value,key){return"nets"==key?checkModifiedNets(value,__backupRule.nets):!_.isEqual(value,__backupRule[key])})}function errorPull(){$state.go("error",{code:"msg_pull_error",message:"msg_error_desc"})}function changeAlg(phase){var modeParam="IKE"==phase?"ike_crypto_mode":"esp_crypto_mode",modes=helper.getList(modeParam,ipsec.rule),modeValue="IKE"==phase?"modeIKE":"modeESP";_.find(modes,{value:ipsec.rule[modeValue]})||(ipsec.rule[modeValue]=modes[0].value);var sizeKeyParam="IKE"==phase?"ike_crypto_skey":"esp_crypto_skey",keys=helper.getList(sizeKeyParam,ipsec.rule),sizeKeyValue="IKE"==phase?"sizeKeyIKE":"sizeKeyESP";_.contains(keys,ipsec.rule[sizeKeyValue])||(ipsec.rule[sizeKeyValue]=keys[0])}function changeHash(phase){var modeParam="IKE"==phase?"ike_hash_mode":"esp_hash_mode",modes=helper.getList(modeParam,ipsec.rule),modeValue="IKE"==phase?"ikeHashMode":"espHashMode";_.find(modes,{value:ipsec.rule[modeValue]})||(ipsec.rule[modeValue]=modes[0].value);var sizeKeyParam="IKE"==phase?"ike_hash_skey":"esp_hash_skey",keys=helper.getList(sizeKeyParam,ipsec.rule),sizeKeyValue="IKE"==phase?"ikeHashSKey":"espHashSKey";_.contains(keys,ipsec.rule[sizeKeyValue])||(ipsec.rule[sizeKeyValue]=keys[0])}function changeVersion(){var algIKE=helper.getList("alg",ipsec.rule);_.find(algIKE,{value:ipsec.rule.alg})||(ipsec.rule.alg=algIKE[0].value);var algESP=helper.getList("alg_ph2",ipsec.rule);_.find(algESP,{value:ipsec.rule.alg_ph2})||(ipsec.rule.alg_ph2=algESP[0].value);var hashIKE=helper.getList("hash",ipsec.rule);_.find(hashIKE,{value:ipsec.rule.hash})||(ipsec.rule.hash=hashIKE[0].value);var hashESP=helper.getList("auth_alg",ipsec.rule);_.find(hashESP,{value:ipsec.rule.auth_alg})||(ipsec.rule.auth_alg=hashESP[0].value),changeAlg("IKE"),changeAlg("ESP"),changeHash("IKE"),changeHash("ESP")}$scope.ipsec={isActivate:!1,apply:apply,remove:remove,wasModified:wasModified,getList:getList,getFilterList:getFilterList,nets:{add:function(){var data={source:"",dest:""};1==ipsec.rule.tcpmss&&(data.mtu=1300),showNetsDialog({data:data})},remove:removeNets,edit:function(item,index){var data={source:item.source,dest:item.dest,index:item.index};1==ipsec.rule.tcpmss&&(data.mtu=item.mtu),showNetsDialog({inx:index,data:data})},constraint:function(){return ipsec.rule.version&&1==ipsec.rule.version&&ipsec.rule.nets.length>0?!0:!1}},changeEnableDPD:function(){ipsec.rule.enableDPD&&(0==ipsec.rule.dpd_delay&&(ipsec.rule.dpd_delay=30),0==ipsec.rule.dpd_maxfail&&(ipsec.rule.dpd_maxfail=2),0==ipsec.rule.dpd_timeout&&(ipsec.rule.dpd_timeout=120))},getMiniTunneledNetworkShort:function(item){var result=[];return item.source&&result.push(translate("ipsec_source")+": "+item.source+";"),item.dest&&result.push(translate("ipsec_dest")+": "+item.dest+";"),result},checkUniqueAndLength:checkUniqueAndLength,support:function(param){return _.has(ipsec.rule,param)},getName:function(param){switch(param){case"Disabled":return"st_disabled";case"Enabled":return"st_enabled";case"Force":return"force"}},showMode:function(alg){return"null"!=alg&&"chacha20poly1305"!=alg},showSizeKey:function(alg){return"3des"!=alg&&"des"!=alg&&"null"!=alg},changeAlg:changeAlg,changeHash:changeHash,changeVersion:changeVersion,validation:function(value,length){return value&&value.length>length?translate("msg_maxlength_symb")+" "+length:null}};var ipsec=$scope.ipsec,__index=_.isUndefined($state.params.inx)?void 0:parseInt($state.params.inx),__backupRule=null,currentState=$state.current.name.split(".");currentState.pop(),currentState=currentState.join(".");var helper;!function(){function __activate(){helper=util.makeHelper(),_.isUndefined(__index)?(ipsec.rule=helper.getDefaultTemplate(!0),ipsec.action="add"):(ipsec.rule=helper.getRule(__index),ipsec.action="edit"),ipsec.rule.enableDPD||(ipsec.rule.enableDPD=0==ipsec.rule.dpd_delay?!1:!0),__backupRule=angular.copy(ipsec.rule),ipsec.isActivate=!0;var ipv6=_.isUndefined(ipsec.rule.ipv6)?!1:ipsec.rule.ipv6;$scope.ipVersion={list:["ipv4","ipv6"],value:ipv6?"ipv6":"ipv4"},$scope.$emit("pageload")}return util.wasActivate()?void __activate():void util.pull().then(__activate)["catch"](errorPull)}(),$scope.$watch("ipVersion.value",function(value,oldValue){value!=oldValue&&(ipsec.rule.ipv6="ipv6"==value?!0:!1,ipsec.rule.leftIface="")},!0)}])}();