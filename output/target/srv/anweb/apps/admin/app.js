"use strict";!function(){function getStates(navs,pageList){var routes=[];return _.each(navs,function(elem,inx){var views,page,state=null;elem.page?_.isObject(elem.page)?(views={},_.each(elem.page,function(_elem,_inx){var view,_page=pageList[_elem];_page&&(view={templateUrl:_.isArray(_page.html)?_.first(_page.html):_page.html,controller:_page.ctrl,controllerAs:_page.ctrlAlias,resolve:getLazyResolve(_page)},views[_inx]=view)}),state={views:views,url:elem.url,params:elem.url?void 0:elem.params}):(page=pageList[elem.page],page&&(state={templateUrl:_.isArray(page.html)?_.first(page.html):page.html,controller:page.ctrl,controllerAs:page.ctrlAlias,url:elem.url,params:elem.params,resolve:getLazyResolve(page)})):state={"abstract":!0,url:elem.url,template:"<ui-view/>"},state&&routes.push({state:inx,config:state})}),routes}function getLazyResolve(page){return page.lazyDeps&&page.lazyDeps.length?{deps:function($q,$rootScope,$state){var deferred=$q.defer();return page.lazyDeps.length||deferred.resolve(),$script(page.lazyDeps,"deps",function(){$rootScope.$apply(function(){app.controllerProvider.has(page.ctrl)?(page.lazyDeps.length=0,deferred.resolve()):(deferred.reject(),$state.go("error",{code:"msg_lazy_load_error",message:"msg_lazy_load_error_desc"}))})}),deferred.promise}}:{deps:function(){}}}function disableScroll($rootHtmlElement){$rootHtmlElement.addClass("disable_scroll")}function enableScroll($rootHtmlElement){$rootHtmlElement.removeClass("disable_scroll")}var defaultPage;svg4everybody(),appDeps=appDeps.concat(["app.config","unsavedChanges","device","app-module-funcs","nw","anweb-storage","svgIcon","ngDialog","angular-progress-arc"]),appDeps.push("duScroll");var app=angular.module("app",appDeps);app.constant("fieldConfig",{style:"material"}),app.config(["unsavedWarningsConfigProvider","$controllerProvider","$filterProvider","$compileProvider","ngDialogProvider","$injector",function(unsavedWarningsConfigProvider,$controllerProvider,$filterProvider,$compileProvider,ngDialogProvider,$injector){var somovd;$injector.has("somovdProvider")&&(somovd=$injector.get("somovdProvider"),somovd.somovdEndPoint="/jsonrpc"),app.controllerProvider=$controllerProvider,app.filterProvider=$filterProvider,app.compileProvider=$compileProvider,unsavedWarningsConfigProvider.useTranslateService=!1,unsavedWarningsConfigProvider.navigateMessage="msg_warn_navigate",unsavedWarningsConfigProvider.reloadMessage="msg_warn_reload",$script.path("/"),ngDialogProvider.setDefaults({closeByDocument:!1,showClose:!1})}]),app.run(["routerHelper","pageList","navigationFilter",function(routerHelper,pageList,navigationFilter){FastClick.attach(document.body);var navs=navigationFilter.filter(),states=getStates(navs,pageList);routerHelper.configureStates(states),_.find(states,function(elem){return"home"==elem.state})?(defaultPage="home",routerHelper.setOtherwise("/home")):(defaultPage="summary",routerHelper.setOtherwise("/summary"))}]),app.controller("AppMobileCtrl",["$scope","$injector","device","history","navigationFilter","pageList","$timeout","$state","translate","$document","$q","$rootScope","devinfo","$window","menus","menuFuncs","notice","ngDialog","overlay-core","snapper","anwebStorage","unloadHandler",function($scope,$injector,device,history,navigationFilter,pageList,$timeout,$state,translate,$document,$q,$rootScope,devinfo,$window,menus,menuFuncs,notice,ngDialog,overlayCore,snapper,anwebStorage){function updateNavs(){menuFuncs.updateNavs($scope)}!function(){function appDataInit(){devinfo.skipAuth.once("version").then(function(data){return data?(data.lang&&translate.changeLanguage(data.lang),data.webMode&&($rootScope.webInterfaceMode=data.webMode),$scope.deviceRelatedStorage=createDeviceRelatedStorage(data),void($scope.deviceInfo=data)):Promise.reject()})["catch"](appDataInit)}function createDeviceRelatedStorage(data){var name="drs-"+data.modelId;return data.deviceMac&&(name+="-"+data.deviceMac),data.serialNumber&&(name+="-"+data.serialNumber),anwebStorage.make(name)}history.clearAll(),$scope.device=device,appDataInit(),function(){$timeout(function(){angular.element(document.getElementsByTagName("body")).removeClass("disable_transitions")},2e3),angular.element(document.getElementById("lblock")).bind("transitionend",updateNavs),angular.element($window).bind("resize",updateNavs)}()}(),$injector.has("eventHandler")?$injector.get("eventHandler"):null,$rootScope.autoconf=autoconf,$scope.devinfo=devinfo,$scope.showGroup="";var navs=navigationFilter.filter();$scope.customRules=navigationFilter.rules(),$scope.menuList=menuFuncs.makeMenuList(navs,pageList),$scope.tabsList=[],$scope.mobileViewStyle="",$scope.mobileMenuShow=!1,$scope.selectedParam="",$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){return!$scope.pageWasLoaded&&function(toState,toParams,fromState,fromParams){return toState.name===fromState.name&&_.isEqual(toParams,fromParams)}(toState,toParams,fromState,fromParams)?void event.preventDefault():($scope.pageWasLoaded=!1,void((toState.controller||toState.views&&toState.views[""])&&!event.defaultPrevented&&$scope.overlay.preloader.start()))}),$scope.$on("$stateChangeSuccess",function(event,state,params,fromState){var snav,navObj=_.find(navs,function(elem,key){return key==state.name});if(navObj&&navObj.menu&&navObj.menu.sref&&navObj.menu.sref!=state.name)return void $state.go(navObj.menu.sref);var stateArr=state.name.split(".");$scope.previousState=fromState.name,$scope.currentState=state.name,$scope.openedMenu=stateArr[0],$scope.showGroup=stateArr[0]+"."+stateArr[1],menuFuncs.makeTabsList&&($scope.tabsList=menuFuncs.makeTabsList($scope.menuList,$state.current));var nav=navs[params.name?params.name:state.name];history.isCleanLastHistory()&&(history.remove(0,-2),history.setCleanLastHistory(!1)),function(toState,fromState){return toState!=fromState}(state,fromState)&&(state.name==defaultPage||history.getObj(-1)||(snav=navs[defaultPage],history.add({title:snav.title,name:defaultPage,params:{}})),state.url?history.add({title:nav.title,name:state.name,params:params}):nav.title&&history.update({title:nav.title},-1),$timeout(function(){$scope.$digest(),updateNavs()})),devinfo.once("Device.DeviceInfo.UpgradeStatus|notice").then(function(data){data&&data["Device.DeviceInfo.UpgradeStatus"]&&data["Device.DeviceInfo.UpgradeStatus"].Device.DeviceInfo.UpgradeStatus>0&&($rootScope.fwUpgradeStatus=!0,$state.go("system.firmware")),$rootScope.isNeedImmediateReboot="NeedImmediateReboot"==data.systemNotice||"NeedSaveAndReboot"==data.systemNotice?!0:!1})}),$rootScope.$on("pageload",function(){$scope.pageWasLoaded=!0}),$scope.$on("changelang",function(){updateNavs()}),$scope.state=function(){return history.getObj(-1)},$scope.backState=function(){return history.getObj(-2)},$scope.goBackState=function(){var state=$scope.backState();state&&(history.setCleanLastHistory(!0),$state.go(state.name,state.params))},$scope.collapseMobileMenu=function(){$scope.mobileViewStyle="",$scope.mobileMenuShow=!1,$scope.selectedMenu=null},$scope.expandMobileMenu=function(){$scope.mobileViewStyle="expanded"},$scope.toggleMobileMenu=function(){"left"==snapper.snap.state().state?snapper.snap.close():snapper.snap.open("left")},$scope.selectFirstLevelMenu=function(menu){var mousemove=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,forceOpenPage=arguments[2];$scope.selectedMenu=$scope.selectedMenu!=menu.id?menu.id:void 0,$scope.selectedSubMenu=null,menu.external&&(location.href=menu.url),!forceOpenPage&&!menu.openPage||mousemove||($state.go(menu.sref,null,{reload:!0}),$scope.collapseMobileMenu(),_.size(snapper.snap)>0&&snapper.snap.close())},$scope.clearSelectedMenu=function(){$scope.selectedMenu=null,$scope.selectedSubMenu=null},$scope.selectSubMenu=function(menu,event){var mousemove=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;menuFuncs.selectSubMenu&&menuFuncs.selectSubMenu($scope,menu,event,mousemove)},$scope.selectSecondLevelMenu=function(menu){menuFuncs.selectSecondLevelMenu($scope,$state,menu)&&snapper.snap.close()},$scope.logout=function($event,isUser){if($event.preventDefault(),$rootScope.dlinkMobileApp.isUserInMobileApp())$rootScope.dlinkMobileApp.askUserToLogout();else{if(isUser&&!confirm(translate("msg_warn_logout")))return;$rootScope.auth.logout()}},function(){var opened=[],$rootHtmlElement=angular.element($document[0].documentElement);$scope.$on("ngDialog.opened",function(e,$dialog){opened.push({element:$dialog,id:$dialog.attr("id")}),disableScroll($rootHtmlElement)}),$scope.$on("ngDialog.closing",function(e,$dialog){var index=_.findIndex(opened,function(elem){return elem.id==$dialog.attr("id")});opened.splice(index,1),enableScroll($rootHtmlElement)}),$scope.$on("$locationChangeStart",function(e){var notCloseDialogs=["login_dialog"];return function(dialogs){return _.some(dialogs,function(dialog){return _.some(notCloseDialogs,function(className){return dialog.element.hasClass(className)})})}(opened)?void e.preventDefault():void(opened.length&&(ngDialog.closeAll(),e.preventDefault()))})}()}])}();