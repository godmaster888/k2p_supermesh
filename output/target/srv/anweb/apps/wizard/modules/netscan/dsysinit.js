"use strict";!function(){var netscan=angular.module(regdep("netscan"),[]);netscan.constant("netscanConstants",{Paths:{dhcp:"Device.Network.ServerDetection.DHCP.",pppoe:"Device.Network.ServerDetection.PPPoE."},TimeScaning:12500,TimeIteration:2e3,Ifaces:{ethernet:"eth1"}}),netscan.service("netscan",["cpe","netscanConstants","$timeout","$interval","funcs",function(cpe,constants,$timeout,$interval,funcs){function start(iface,ifname){return __isScaning?Promise.reject():(__isScaning=!0,stopTimerPromise=$timeout(stopAllTimer,constants.TimeScaning).then(function(){console.log("Stop Timer")}),Promise.all([scan("dhcp",ifname),scan("pppoe",ifname)]).then(function(){var result;return __isScaning?($timeout.cancel(stopTimerPromise),result=getResult(),__isScaning=!1,Promise.resolve(result)):Promise.reject()}))}function stop(){stopAllTimer(),$timeout.cancel(stopTimerPromise),data={},__isScaning=!1}function stopAllTimer(){_.each(data,function(item){item.__IntervalPromise&&$interval.cancel(item.__IntervalPromise)})}function getResult(){var result={},isDHCP=data.dhcp&&data.dhcp.__Success,isPPPoE=data.pppoe&&data.pppoe.__Success;return result.WANType=isPPPoE&&isDHCP?"dynpppoe":isPPPoE?"pppoe":isDHCP?"dynip":null,_.each(data,function(item){item.__Success&&(result=_.chain(result).extend(item).omit("__Success","__IntervalPromise").value())}),result}function scan(proto,ifname){function query(){var params=[{Name:"Ifname",Value:ifname||"eth1"},{Name:"Timeout",Value:Math.floor(constants.TimeIteration/1e3)}];return cpe.Execute(constants.Paths[proto],params).then(function(answer){var result=answer.result&&funcs.buildTree(answer.result.ParameterList);return result&&result.Found&&!result.Error?(data[proto].__Success=!0,result.ServiceName&&(data[proto].ServiceName=result.ServiceName),Promise.resolve()):Promise.reject()})}return new Promise(function(resolve){function __query(){isWait||(isWait=!0,query().then(function(){$interval.cancel(data[proto].__IntervalPromise),resolve(),isWait=!1},function(){isWait=!1}))}var isWait=!1;data[proto]={__Success:!1,__IntervalPromise:null},stopTimerPromise.then(function(){return resolve()}),__query(),data[proto].__IntervalPromise=$interval(__query,constants.TimeIteration+100)})}var data={},__isScaning=!1,stopTimerPromise=null;return{start:start,stop:stop}}])}();