"use strict";angular.module("wizard").controller("wizardDefaultsCtrl",["$scope","$rootScope","stepManager","device","profiles","devinfo","manualBuilder","$http","$timeout","translate","deviceAvailable","$state",function($scope,$rootScope,stepManager,device,profiles,devinfo,manualBuilder,$http,$timeout,translate,deviceAvailable,$state){function getMode(mode){return{OPEN:"None",WEP:"WEP",WPAPSK:"WPA-Personal",WPA2PSK:"WPA2-Personal",WPAPSKWPA2PSK:"WPA-WPA2-Personal",WPA:"WPA-Enterprise",WPA2:"WPA2-Enterprise",WPA1WPA2:"WPA-WPA2-Enterprise"}[mode]}function init(){$rootScope.showOverlay(!0),devinfo.once("version|wifi_general|notice|net").then(function(data){function getLast4DigitsOfMac(){return data.deviceMac.replace(/:/g,"").slice(-4).toUpperCase()}var macPrefix;if($rootScope.rootAutoGeneratedSSID)var macPrefix="";else macPrefix=data.deviceMac?"-"+getLast4DigitsOfMac():"";data.needChangeSSID24&&data.wifi_general.f24.exists&&($scope.profile.$WiFiStep[2.4]={SSID:data.wifi_general.f24.ssid+macPrefix,OriginSSID:data.wifi_general.f24.ssid,PSK:data.wifi_general.f24.WPAPSK,WithoutPass:"OPEN"==data.wifi_general.f24.authMode,DefaultSecurityMode:getMode(data.wifi_general.f24.authMode)},data.wifi_general.f24.guestExists?($scope.profile.$WiFiStep[2.4].GuestAP=!0,$scope.profile.$WiFiStep[2.4].GuestSSID=data.wifi_general.f24.guestSsid,$scope.profile.$WiFiStep[2.4].GuestWithoutPass="OPEN"==data.wifi_general.f24.guestAuthMode,$scope.profile.$WiFiStep[2.4].GuestPSK=data.wifi_general.f24.guestWPAPSK,$scope.profile.$WiFiStep[2.4].GuestMaxAssociatedDevices=data.wifi_general.f24.guestMaxStaNum):$scope.profile.$WiFiStep[2.4].GuestAP=!1),data.needChangeSSID5&&data.wifi_general.f5.exists&&($scope.profile.$WiFiStep[5]={SSID:data.wifi_general.f5.ssid+macPrefix,OriginSSID:data.wifi_general.f5.ssid,PSK:data.wifi_general.f5.WPAPSK,WithoutPass:"OPEN"==data.wifi_general.f5.authMode,DefaultSecurityMode:getMode(data.wifi_general.f5.authMode)},data.wifi_general.f5.guestExists?($scope.profile.$WiFiStep[5].GuestAP=!0,$scope.profile.$WiFiStep[5].GuestSSID=data.wifi_general.f5.guestSsid,$scope.profile.$WiFiStep[5].GuestWithoutPass="OPEN"==data.wifi_general.f5.guestAuthMode,$scope.profile.$WiFiStep[5].GuestPSK=data.wifi_general.f5.guestWPAPSK,$scope.profile.$WiFiStep[5].GuestMaxAssociatedDevices=data.wifi_general.f5.guestMaxStaNum):$scope.profile.$WiFiStep[5].GuestAP=!1),$scope.needChangePass="NeedChangePass"==data.systemNotice,$scope.needLocalAddressField="ap"==data.deviceMode,$scope.needLocalAddressField&&($scope.profile.$LANStep={IPv4:{StaticIP:{1:{AddnHostname:"dlinkap"+getLast4DigitsOfMac().toLowerCase()+".local"}}}},$scope.hostNameExample="dlinkap12ab.local./"),$rootScope.showOverlay(!1)})["catch"](init)}var SUPPORT_WIFI_5GHZ=autoconf.BR2_PACKAGE_ANWEB_WIFI_5GHZ;$scope.needChangePSK=autoconf.BR2_PACKAGE_ANWEB_CUSTOM_PLANETA_21337||autoconf.BR2_PACKAGE_ANWEB_CUSTOM_NOVOTEL_39180,$scope.stepData=stepManager.getData(),$scope.customPrevStep=function(){stepManager.action("prev")},$scope.getSSSIDName=function(band){var key=translate("dcc_wifi_name");return"2.4"==band?key+String(SUPPORT_WIFI_5GHZ?" 2.4 "+translate("units_GHz")+" (SSID)":" (SSID)"):key+" 5 "+translate("units_GHz")+" (SSID)"},$scope.getPSKName=function(band){var key=translate("password");return"2.4"==band?key+String(SUPPORT_WIFI_5GHZ?" 2.4 "+translate("units_GHz")+" (PSK)":" (PSK)"):key+" 5 "+translate("units_GHz")+" (PSK)"},$scope.validateSSID=function(origin,value){return $rootScope.rootAutoGeneratedSSID||value!=origin?null:"msg_change_pass_ssid_def_error"},$scope.validatePSK=function(value){if(value){if(!(value.length>=8&&value.length<=63))return"msg_invalid_password_length";if(/[а-яА-Я]+/.test(value))return"dcc_wifi_cyrillic";if(!/^[\x20-\x7E]+$/g.test(value))return"msg_password_contains_illegal"}return null},$scope.validatePassword=function(value){return"admin"==value?"msg_change_pass_def_error":null},$scope.confirmPasswordValidate=function(value){return""!=value&&$scope.profile.$PasswordStep.Password!=value?"dcc_password_not_identical":null},$scope.profile={$WiFiStep:{},$PasswordStep:{Login:autoconf.BR2_PACKAGE_ANWEB_ADMIN_NAME,Password:"",PasswordConfirm:""},$SystemLanguage:{Language:translate.getLang()}},$scope.apply=function(){$timeout(function(){var nativeModel,waitDevTimeout;$scope.$emit("goToErrorForm",!0),$scope.form.$valid&&($rootScope.showOverlay(!0),$rootScope.showAvailOverlay(!1),console.log("manualModel",$scope.profile),nativeModel=$rootScope.nativeData=manualBuilder.build($scope.profile),waitDevTimeout=45e3,$state.go("waitdevice",{action:"exit",condition:"dcc_finished",timeout:waitDevTimeout}).then(function(){profiles.apply(nativeModel),$rootScope.dlinkMobileApp.isUserInMobileApp()&&$rootScope.dlinkMobileApp.wizardCompleted&&$rootScope.dlinkMobileApp.wizardCompleted(nativeModel),$rootScope.setAutoAuth($scope.profile.$PasswordStep.Login,$scope.profile.$PasswordStep.Password)}))})},init()}]);